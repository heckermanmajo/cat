name: Build CatKnows

on:
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to production server'
        required: false
        default: false
        type: boolean
      release:
        description: 'Create GitHub Release'
        required: false
        default: false
        type: boolean
      version:
        description: 'Release version (z.B. v1.0.0) - nur nÃ¶tig wenn Release aktiviert'
        required: false
        type: string

jobs:
  # ============================================================================
  # Python App Build (Nuitka)
  # ============================================================================
  build-python:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: catknows-linux
          - os: windows-latest
            artifact_name: catknows-windows
          - os: macos-latest
            artifact_name: catknows-macos

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: myversion/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r myversion/requirements.txt

      - name: Build with Nuitka
        working-directory: myversion
        run: python build.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: myversion/dist/
          if-no-files-found: error

  # ============================================================================
  # Electron Fetcher Build
  # ============================================================================
  build-electron:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: fetcher-linux
            build_cmd: npm run build:linux
          - os: windows-latest
            artifact_name: fetcher-windows
            build_cmd: npm run build:win
          - os: macos-latest
            artifact_name: fetcher-macos
            build_cmd: npm run build:mac

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron-fetcher/package-lock.json

      - name: Install dependencies
        working-directory: electron-fetcher
        run: npm ci || npm install

      - name: Build Electron App
        working-directory: electron-fetcher
        run: ${{ matrix.build_cmd }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: electron-fetcher/dist/
          if-no-files-found: error

  deploy:
    needs: [build-python, build-electron]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy == 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find artifacts -type f -name "*" | head -50

      - name: Prepare deployment package
        run: |
          # Downloads-Ordner erstellen
          mkdir -p webserver/downloads

          # === Python App ===
          # Linux: tar.gz
          chmod +x artifacts/catknows-linux/catknows
          tar -czvf webserver/downloads/catknows-linux.tar.gz -C artifacts/catknows-linux catknows

          # Windows: exe
          cp artifacts/catknows-windows/catknows.exe webserver/downloads/catknows-win.exe

          # macOS: zip
          chmod +x artifacts/catknows-macos/catknows
          zip -j webserver/downloads/catknows-mac.zip artifacts/catknows-macos/catknows

          # === Electron Fetcher ===
          # Linux: AppImage
          cp artifacts/fetcher-linux/*.AppImage webserver/downloads/fetcher-linux.AppImage 2>/dev/null || echo "No AppImage found"

          # Windows: Portable exe
          cp artifacts/fetcher-windows/*.exe webserver/downloads/fetcher-win.exe 2>/dev/null || echo "No Windows exe found"

          # macOS: zip
          cp artifacts/fetcher-macos/*.zip webserver/downloads/fetcher-mac.zip 2>/dev/null || \
          zip -j webserver/downloads/fetcher-mac.zip artifacts/fetcher-macos/*.app 2>/dev/null || echo "No macOS build found"

          echo "=== Downloads folder ==="
          ls -la webserver/downloads/

          # ZIP erstellen (ohne .md und excalidraw)
          cd webserver
          zip -r ../web.zip ./* -x "*.md" "*excalidraw*"
          cd ..
          ls -la web.zip

      - name: Deploy to production server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: w016728f.kasserver.com
          SSH_USER: ssh-w016728f
          DEPLOY_PATH: /www/htdocs/w016728f/testing.cat-knows.com/
        run: |
          # SSH-Key einrichten
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

          # Upload und entpacken
          scp web.zip ${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}
          ssh ${SSH_USER}@${SSH_HOST} "cd ${DEPLOY_PATH} && unzip -o web.zip && rm web.zip"

          echo "Deployment erfolgreich!"

  release:
    needs: [build-python, build-electron]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.release == 'true' }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create and push tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag ${{ inputs.version }}
          git push origin ${{ inputs.version }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir release

          # Python App
          cp artifacts/catknows-linux/catknows release/catknows-linux
          cp artifacts/catknows-windows/catknows.exe release/catknows-windows.exe
          cp artifacts/catknows-macos/catknows release/catknows-macos

          # Electron Fetcher
          cp artifacts/fetcher-linux/*.AppImage release/ 2>/dev/null || true
          cp artifacts/fetcher-windows/*.exe release/fetcher-windows.exe 2>/dev/null || true
          cp artifacts/fetcher-macos/*.zip release/fetcher-macos.zip 2>/dev/null || true

          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          files: release/*
          generate_release_notes: true
