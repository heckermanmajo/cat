name: Build CatKnows

on:
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to production server'
        required: false
        default: false
        type: boolean
      release:
        description: 'Create GitHub Release'
        required: false
        default: false
        type: boolean
      version:
        description: 'Release version (e.g. 1.0.0) - only needed if Release is enabled'
        required: false
        type: string

jobs:
  # ============================================================================
  # Build combined app (Python + Electron + Launcher) for each platform
  # ============================================================================
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            python_binary: catknows
            launcher_binary: CatKnowsLauncher
            electron_artifact: "*.AppImage"
            app_name: CatKnows.AppImage
          - os: windows-latest
            platform: windows
            python_binary: catknows.exe
            launcher_binary: CatKnowsLauncher.exe
            electron_artifact: "*.exe"
            app_name: CatKnows.exe
          - os: macos-latest
            platform: macos
            python_binary: catknows
            launcher_binary: CatKnowsLauncher
            electron_artifact: "*.zip"
            app_name: CatKnows.zip

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ========================================
      # Step 1: Build Python App
      # ========================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: myversion/requirements.txt

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r myversion/requirements.txt

      - name: Build Python with Nuitka
        working-directory: myversion
        run: python build.py

      # ========================================
      # Step 2: Build Launcher
      # ========================================
      - name: Build Launcher with Nuitka
        working-directory: launcher
        run: python build.py

      # ========================================
      # Step 3: Copy Python into Electron
      # ========================================
      - name: Copy Python binary to Electron
        shell: bash
        run: |
          mkdir -p electron-fetcher/python
          cp myversion/dist/${{ matrix.python_binary }} electron-fetcher/python/
          ls -la electron-fetcher/python/

      # ========================================
      # Step 4: Build Electron App
      # ========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Electron dependencies
        working-directory: electron-fetcher
        run: npm install

      - name: Build Electron App
        working-directory: electron-fetcher
        run: npm run build

      # ========================================
      # Step 5: Create distribution package
      # ========================================
      - name: Create distribution package
        shell: bash
        run: |
          mkdir -p dist-package

          # Copy Electron app (rename to standard name)
          find electron-fetcher/dist -name "${{ matrix.electron_artifact }}" -exec cp {} dist-package/${{ matrix.app_name }} \; 2>/dev/null || true

          # Copy launcher
          cp launcher/dist/${{ matrix.launcher_binary }} dist-package/

          # Copy version.txt
          cp version.txt dist-package/

          echo "=== Distribution package ==="
          ls -la dist-package/

      - name: List build output
        shell: bash
        run: |
          echo "=== Build output ==="
          find electron-fetcher/dist -type f -name "*" 2>/dev/null | head -20 || true

      # ========================================
      # Step 6: Upload artifacts
      # ========================================
      - name: Upload distribution package
        uses: actions/upload-artifact@v4
        with:
          name: catknows-${{ matrix.platform }}
          path: dist-package/
          if-no-files-found: error

      - name: Upload Electron standalone (for updates)
        uses: actions/upload-artifact@v4
        with:
          name: catknows-app-${{ matrix.platform }}
          path: electron-fetcher/dist/
          if-no-files-found: error

  # ============================================================================
  # Deploy to production server
  # ============================================================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy == 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find artifacts -type f | head -30

      - name: Prepare deployment package
        run: |
          mkdir -p webserver/downloads

          # Copy version.txt for auto-updater (use input version if provided, else repo version)
          if [ -n "${{ inputs.version }}" ]; then
            echo "${{ inputs.version }}" > webserver/downloads/version.txt
          else
            cp version.txt webserver/downloads/
          fi

          # === Standalone apps for auto-updater ===
          # Linux: AppImage
          find artifacts/catknows-app-linux -name "*.AppImage" -exec cp {} webserver/downloads/CatKnows-linux.AppImage \; 2>/dev/null || echo "No Linux AppImage"

          # Windows: exe
          find artifacts/catknows-app-windows -name "*.exe" -exec cp {} webserver/downloads/CatKnows-win.exe \; 2>/dev/null || echo "No Windows exe"

          # macOS: zip
          find artifacts/catknows-app-macos -name "*.zip" -exec cp {} webserver/downloads/CatKnows-mac.zip \; 2>/dev/null || echo "No macOS zip"

          # === Full distribution ZIPs for initial download (with launcher) ===
          cd artifacts/catknows-linux && zip -r ../../webserver/downloads/CatKnows-linux.zip ./* && cd ../..
          cd artifacts/catknows-windows && zip -r ../../webserver/downloads/CatKnows-windows.zip ./* && cd ../..
          cd artifacts/catknows-macos && zip -r ../../webserver/downloads/CatKnows-macos.zip ./* && cd ../..

          echo "=== Downloads folder ==="
          ls -la webserver/downloads/

          # Create web.zip for deployment
          cd webserver
          zip -r ../web.zip ./* -x "*.md" "*excalidraw*"
          cd ..
          ls -la web.zip

      - name: Deploy to production server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: w016728f.kasserver.com
          SSH_USER: ssh-w016728f
          DEPLOY_PATH: /www/htdocs/w016728f/testing.cat-knows.com/
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

          scp web.zip ${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}
          ssh ${SSH_USER}@${SSH_HOST} "cd ${DEPLOY_PATH} && unzip -o web.zip && rm web.zip"

          echo "Deployment successful!"

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  release:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.release == 'true' }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update version.txt
        if: ${{ inputs.version != '' }}
        run: |
          echo "${{ inputs.version }}" > version.txt
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add version.txt
          git commit -m "chore: bump version to ${{ inputs.version }}" || true
          git push || true

      - name: Create and push tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag v${{ inputs.version }}
          git push origin v${{ inputs.version }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir release

          # Create distribution ZIPs (with launcher)
          cd artifacts/catknows-linux && zip -r ../../release/CatKnows-linux.zip ./* && cd ../..
          cd artifacts/catknows-windows && zip -r ../../release/CatKnows-windows.zip ./* && cd ../..
          cd artifacts/catknows-macos && zip -r ../../release/CatKnows-macos.zip ./* && cd ../..

          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          files: release/*
          generate_release_notes: true
