name: Build CatKnows

on:
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to production server'
        required: false
        default: false
        type: boolean
      release:
        description: 'Create GitHub Release'
        required: false
        default: false
        type: boolean
      version:
        description: 'Release version (e.g. v1.0.0) - only needed if Release is enabled'
        required: false
        type: string

jobs:
  # ============================================================================
  # Build combined app (Python + Electron) for each platform
  # ============================================================================
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            python_binary: catknows
            electron_artifact: "*.AppImage"
          - os: windows-latest
            platform: windows
            python_binary: catknows.exe
            electron_artifact: "*.exe"
          - os: macos-latest
            platform: macos
            python_binary: catknows
            electron_artifact: "*.zip"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ========================================
      # Step 1: Build Python App
      # ========================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: myversion/requirements.txt

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r myversion/requirements.txt

      - name: Build Python with Nuitka
        working-directory: myversion
        run: python build.py

      # ========================================
      # Step 2: Copy Python into Electron
      # ========================================
      - name: Copy Python binary to Electron
        shell: bash
        run: |
          mkdir -p electron-fetcher/python
          cp myversion/dist/${{ matrix.python_binary }} electron-fetcher/python/
          # Also copy static files that Python needs
          cp -r myversion/static electron-fetcher/python/ 2>/dev/null || true
          ls -la electron-fetcher/python/

      # ========================================
      # Step 3: Build Electron App
      # ========================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Electron dependencies
        working-directory: electron-fetcher
        run: npm install

      - name: Build Electron App
        working-directory: electron-fetcher
        run: npm run build

      - name: List build output
        shell: bash
        run: |
          echo "=== Build output ==="
          find electron-fetcher/dist -type f -name "*" 2>/dev/null | head -20 || true

      # ========================================
      # Step 4: Upload artifact
      # ========================================
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: catknows-${{ matrix.platform }}
          path: electron-fetcher/dist/
          if-no-files-found: error

  # ============================================================================
  # Deploy to production server
  # ============================================================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy == 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          find artifacts -type f | head -30

      - name: Prepare deployment package
        run: |
          mkdir -p webserver/downloads

          # Linux: AppImage
          find artifacts/catknows-linux -name "*.AppImage" -exec cp {} webserver/downloads/CatKnows-linux.AppImage \; 2>/dev/null || echo "No Linux AppImage"

          # Windows: exe
          find artifacts/catknows-windows -name "*.exe" -exec cp {} webserver/downloads/CatKnows-win.exe \; 2>/dev/null || echo "No Windows exe"

          # macOS: zip
          find artifacts/catknows-macos -name "*.zip" -exec cp {} webserver/downloads/CatKnows-mac.zip \; 2>/dev/null || echo "No macOS zip"

          echo "=== Downloads folder ==="
          ls -la webserver/downloads/

          # Create web.zip for deployment
          cd webserver
          zip -r ../web.zip ./* -x "*.md" "*excalidraw*"
          cd ..
          ls -la web.zip

      - name: Deploy to production server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: w016728f.kasserver.com
          SSH_USER: ssh-w016728f
          DEPLOY_PATH: /www/htdocs/w016728f/testing.cat-knows.com/
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

          scp web.zip ${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}
          ssh ${SSH_USER}@${SSH_HOST} "cd ${DEPLOY_PATH} && unzip -o web.zip && rm web.zip"

          echo "Deployment successful!"

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  release:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.release == 'true' }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create and push tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag ${{ inputs.version }}
          git push origin ${{ inputs.version }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir release

          # Linux
          find artifacts/catknows-linux -name "*.AppImage" -exec cp {} release/CatKnows-linux.AppImage \; 2>/dev/null || true

          # Windows
          find artifacts/catknows-windows -name "*.exe" -exec cp {} release/CatKnows-windows.exe \; 2>/dev/null || true

          # macOS
          find artifacts/catknows-macos -name "*.zip" -exec cp {} release/CatKnows-macos.zip \; 2>/dev/null || true

          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          files: release/*
          generate_release_notes: true
