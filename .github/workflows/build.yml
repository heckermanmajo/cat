name: Build CatKnows

on:
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to production server'
        required: false
        default: false
        type: boolean
      release:
        description: 'Create GitHub Release'
        required: false
        default: false
        type: boolean
      version:
        description: 'Release version (z.B. v1.0.0) - nur nÃ¶tig wenn Release aktiviert'
        required: false
        type: string

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: catknows-linux
          - os: windows-latest
            artifact_name: catknows-windows
          - os: macos-latest
            artifact_name: catknows-macos

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: myversion/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r myversion/requirements.txt

      - name: Build with Nuitka
        working-directory: myversion
        run: python build.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: myversion/dist/
          if-no-files-found: error

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy == 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare deployment package
        run: |
          # Downloads-Ordner erstellen
          mkdir -p webserver/downloads

          # Linux: tar.gz
          chmod +x artifacts/catknows-linux/catknows
          tar -czvf webserver/downloads/catknows-linux.tar.gz -C artifacts/catknows-linux catknows

          # Windows: exe umbenennen
          cp artifacts/catknows-windows/catknows.exe webserver/downloads/catknows-win.exe

          # macOS: zip
          chmod +x artifacts/catknows-macos/catknows
          zip -j webserver/downloads/catknows-mac.zip artifacts/catknows-macos/catknows

          ls -la webserver/downloads/

          # ZIP erstellen (ohne .md und excalidraw)
          cd webserver
          zip -r ../web.zip ./* -x "*.md" "*excalidraw*"
          cd ..
          ls -la web.zip

      - name: Deploy to production server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: w016728f.kasserver.com
          SSH_USER: ssh-w016728f
          DEPLOY_PATH: /www/htdocs/w016728f/testing.cat-knows.com/
        run: |
          # SSH-Key einrichten
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

          # Upload und entpacken
          scp web.zip ${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}
          ssh ${SSH_USER}@${SSH_HOST} "cd ${DEPLOY_PATH} && unzip -o web.zip && rm web.zip"

          echo "Deployment erfolgreich!"

  release:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.release == 'true' }}
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create and push tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag ${{ inputs.version }}
          git push origin ${{ inputs.version }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir release
          cp artifacts/catknows-linux/catknows release/catknows-linux
          cp artifacts/catknows-windows/catknows.exe release/catknows-windows.exe
          cp artifacts/catknows-macos/catknows release/catknows-macos
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version }}
          files: release/*
          generate_release_notes: true
