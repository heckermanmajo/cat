<html>
    <head>
        <script src="entity.js"></script>
        <script src="/entities/config_entry.js"></script>
        <script src="/lib.js"></script>
        <link href="/default.css" type="text/css" rel="stylesheet">
        <script>
            let currentView = "fetchqueue";
            window.onload = async () => {
               lib.setupThemeOnLoad().then();
               currentView = (await ConfigEntry.get('data.currentView') ) || currentView;
               nav(currentView);
               loadFetchSettings();
            }

            async function loadFetchSettings(){
                const keys = [
                    'comments_max_post_age_days',
                    'likes_max_post_age_days', 'likes_fetch_comments',
                    'min_shared_members',
                    'stale_base', 'stale_profile', 'stale_comments',
                    'max_post_age_days', 'max_user_inactive_days'
                ];
                for(const key of keys){
                    const val = await ConfigEntry.get(key);
                    const el = document.getElementById('set_' + key);
                    if(!el) continue;
                    if(el.type === 'checkbox'){
                        el.checked = val === 'true';
                    } else if(val){
                        el.value = val;
                    }
                }
            }

            async function saveFetchSettings(){
                const settings = {
                    'comments_max_post_age_days': document.getElementById('set_comments_max_post_age_days').value,
                    'likes_max_post_age_days': document.getElementById('set_likes_max_post_age_days').value,
                    'likes_fetch_comments': document.getElementById('set_likes_fetch_comments').checked ? 'true' : 'false',
                    'min_shared_members': document.getElementById('set_min_shared_members').value,
                    'stale_base': document.getElementById('set_stale_base').value,
                    'stale_profile': document.getElementById('set_stale_profile').value,
                    'stale_comments': document.getElementById('set_stale_comments').value,
                    'max_post_age_days': document.getElementById('set_max_post_age_days').value,
                    'max_user_inactive_days': document.getElementById('set_max_user_inactive_days').value,
                };
                for(const [key, val] of Object.entries(settings)){
                    await ConfigEntry.set(key, val);
                }
                document.getElementById('settings-status').textContent = 'Saved!';
                setTimeout(() => document.getElementById('settings-status').textContent = '', 2000);
            }
            function nav(path){
                ConfigEntry.set('data.currentView', path).then();
                document.querySelectorAll("main").forEach((el) => el.style.display = 'none' );
                let el = document.getElementById(path)
                el.style.display = 'block';
            }
            async function resetFailedAbout(){
                const res = await fetch('/api/reset-failed-about', {method: 'POST'});
                const data = await res.json();
                alert('Reset: ' + data.reset + ' communities\n' + (data.slugs || []).join(', '));
                generateQueue();
            }

            async function generateQueue(){
                const res = await fetch('/api/fetch-tasks');
                const tasks = await res.json();
                const target = document.getElementById('fetchqueue-target');
                if(!tasks.length){ target.innerHTML = '<p>Keine Tasks</p>'; return; }
                // Count tasks by type
                const typeCounts = {};
                for (const t of tasks) { typeCounts[t.type] = (typeCounts[t.type] || 0) + 1; }
                const summary = Object.entries(typeCounts).map(([type, count]) => `(${count}) ${type}`).join(' ');
                let html = `<b>${tasks.length} Tasks:</b> ${summary}<br><table><tr><th>Type</th><th>Community</th><th>Comment</th><th>Page</th><th>User</th><th>Post</th></tr>`;
                for (const t of tasks) {
                    html += `<tr>
                        <td>${t.type}</td>
                        <td>${t.communitySlug}</td>
                        <td><small>${t.comment || '-'}</small></td>
                        <td>${t.pageParam || '-'}</td>
                        <td>${t.userName || '-'}</td>
                        <td>${t.postName || '-'}</td>
                    </tr>`;
                }
                target.innerHTML = html + '</table>';
            }
            async function loadRawData(){
                const res = await fetch('/api/fetch');
                const data = await res.json();
                const target = document.getElementById('rawdata-target');
                if(!data.length){ target.innerHTML = '<p>Keine Fetches vorhanden</p>'; return; }
                let html = '';
                for (const f of data) {
                    const raw_data = JSON.stringify(JSON.parse(f.raw_data), null, 2);
                    html+= `<div style="border:1px solid #333; margin:5px; padding:10px;">
                        <b>#${f.id}</b> | ${f.type} | ${f.community_slug} | page ${f.page_param} | ${f.status} |
                        ${f.error_message ? `<br><small style="color:red">${f.error_message}</small>` : ''}
                        <small>${new Date(f.created_at * 1000).toLocaleString()}</small>
                        <details><summary>Raw Data</summary><pre style="max-height:200px;overflow:auto;font-size:11px">${raw_data}</pre></details>
                    </div>`;
                }
                target.innerHTML = html;
            }

            async function showOverview(){
                const res = await fetch('/api/database/overview');
                const data = await res.json();
                const target = document.getElementById('data-content');
                if(!data.length){ target.innerHTML = '<p>Keine Tabellen vorhanden</p>'; return; }
                let total = data.reduce((sum, t) => sum + t.count, 0);
                let html = `<h3>Database Overview</h3><p>Total: ${total} entries</p><table><tr><th>Table</th><th>Entries</th></tr>`;
                for (const t of data) {
                    html += `<tr><td>${t.name}</td><td>${t.count}</td></tr>`;
                }
                target.innerHTML = html + '</table>';
            }

            async function showDataTab(tab){
                const target = document.getElementById('data-content');
                if(tab === 'users'){
                    const res = await fetch('/api/user');
                    const data = await res.json();
                    if(!data.length){ target.innerHTML = '<p>Keine Users vorhanden</p>'; return; }
                    let html = '<table><tr><th>ID</th><th>Skool ID</th><th>Name</th><th>Email</th><th>Role</th><th>Community</th><th>Fetched</th></tr>';
                    for (const u of data) {
                        html += `<tr>
                            <td>${u.id}</td>
                            <td><small>${u.skool_id}</small></td>
                            <td>${u.name}</td>
                            <td>${u.email}</td>
                            <td>${u.member_role}</td>
                            <td>${u.community_slug}</td>
                            <td><small>${new Date(u.fetched_at * 1000).toLocaleString()}</small></td>
                        </tr>`;
                    }
                    target.innerHTML = html + '</table>';
                }
                if(tab === 'posts'){
                    const res = await fetch('/api/post/latest');
                    const data = await res.json();
                    if(!data.length){ target.innerHTML = '<p>Keine Posts vorhanden</p>'; return; }
                    let html = '<table><tr><th>ID</th><th>Skool ID</th><th>Title</th><th>Author</th><th>Type</th><th>Community</th><th>Fetched</th></tr>';
                    for (const p of data) {
                        const meta = p.metadata ? JSON.parse(p.metadata) : {};
                        html += `<tr>
                            <td>${p.id}</td>
                            <td><small>${p.skool_id}</small></td>
                            <td>${meta.title || p.name}</td>
                            <td>${p.user_name}</td>
                            <td>${p.post_type}</td>
                            <td>${p.community_slug}</td>
                            <td><small>${new Date(p.fetched_at * 1000).toLocaleString()}</small></td>
                        </tr>`;
                    }
                    target.innerHTML = html + '</table>';
                }
                if(tab === 'profiles'){
                    const res = await fetch('/api/profile');
                    const data = await res.json();
                    if(!data.length){ target.innerHTML = '<p>Keine Profiles vorhanden</p>'; return; }
                    let html = '<table><tr><th>ID</th><th>Skool ID</th><th>Name</th><th>Posts</th><th>Followers</th><th>Following</th><th>Contributions</th><th>Fetched</th></tr>';
                    for (const p of data) {
                        html += `<tr>
                            <td>${p.id}</td>
                            <td><small>${p.skool_id}</small></td>
                            <td>${p.name}</td>
                            <td>${p.total_posts}</td>
                            <td>${p.total_followers}</td>
                            <td>${p.total_following}</td>
                            <td>${p.total_contributions}</td>
                            <td><small>${new Date(p.fetched_at * 1000).toLocaleString()}</small></td>
                        </tr>`;
                    }
                    target.innerHTML = html + '</table>';
                }
            }

            async function extractAll(){
                // Dialog erstellen
                const dialog = document.createElement('dialog');
                dialog.innerHTML = `
                    <h3>Extraktion läuft...</h3>
                    <p style="color:orange"><b>Fenster nicht schließen!</b></p>
                    <div id="ext-progress-text">Starte...</div>
                    <progress id="ext-progress-bar" value="0" max="100" style="width:300px"></progress>
                    <div id="ext-stats" style="margin-top:10px;font-size:12px"></div>
                `;
                document.body.appendChild(dialog);
                dialog.showModal();

                // Info holen
                const info = await fetch('/api/extract-info').then(r => r.json());
                const total = info.total;
                if(total === 0){
                    dialog.innerHTML = `<h3>Keine Fetches vorhanden</h3><button onclick="this.closest('dialog').close()">OK</button>`;
                    return;
                }
                const batchSize = 50;

                // Batches durchlaufen
                let processed = 0;
                let totals = {users: 0, posts: 0, comments: 0, profiles: 0, leaderboard: 0, other_communities: 0};

                while(processed < total){
                    const res = await fetch('/api/extract-batch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({offset: processed, limit: batchSize})
                    }).then(r => r.json());

                    processed += res.processed;
                    totals.users += res.extracted.users;
                    totals.posts += res.extracted.posts;
                    totals.comments += res.extracted.comments;
                    totals.profiles += res.extracted.profiles;
                    totals.leaderboard += res.extracted.leaderboard;
                    totals.other_communities += res.extracted.other_communities;

                    // Progress updaten
                    const percent = Math.round((processed / total) * 100);
                    dialog.querySelector('#ext-progress-bar').value = percent;
                    dialog.querySelector('#ext-progress-text').textContent = `${processed} / ${total} Fetches (${percent}%)`;
                    dialog.querySelector('#ext-stats').innerHTML = `Users: ${totals.users} | Posts: ${totals.posts} | Comments: ${totals.comments} | Profiles: ${totals.profiles}`;
                }

                // Fertig
                dialog.innerHTML = `
                    <h3>Fertig!</h3>
                    <p>Extrahiert:</p>
                    <ul>
                        <li>${totals.users} Users</li>
                        <li>${totals.posts} Posts</li>
                        <li>${totals.comments} Comments</li>
                        <li>${totals.profiles} Profiles</li>
                        <li>${totals.leaderboard} Leaderboard</li>
                        <li>${totals.other_communities} Other Communities</li>
                    </ul>
                    <button onclick="this.closest('dialog').close()">OK</button>
                `;
            }
        </script>
        <title>Cat</title>
    </head>
    <body>

        <header style="height: 30px">

            <select id="viewSelection" onchange="window.location.href=this.value">
                <option value="/members.html"> MEMBERS </option>
                <option value="/posts.html"> POSTS </option>
                <option value="/communities.html"> COMMUNITIES </option>
                <option value="/chats.html" > CHATS </option>
                <option value="/prompts.html"> PROMPTS </option>
                <option value="/data.html" selected> DATABASE </option>
            </select>

            <button onclick="nav('fetchqueue')"> Fetch-Queue </button>
            <button onclick="nav('rawdata')"> Raw Data </button>
            <button onclick="nav('data')"> Data </button>

            <nav style="float: right">
                <select>
                    <option>Community name1</option>
                    <option>Community name2</option>
                    <option>Community name3</option>
                    <option>Community name4</option>
                </select>
                <select id="themeSelection" onchange="setTheme(this.value).then()">
                    <option value="blue"> Blue </option>
                    <option value="red"> Red </option>
                </select>
            </nav>

        </header>

        <main id="fetchqueue" style="display: none">
            <div style="display:flex; gap:20px;">
                <div style="flex:1">
                    <h3>Fetch Queue</h3>
                    <button onclick="generateQueue()">Generate QUEUE</button>
                    <button onclick="resetFailedAbout()">Reset Failed Tasks</button>
                    <div id='fetchqueue-target'></div>
                </div>
                <div style="width:450px; padding:15px; border:1px solid #444; background:#1a1a1a;">
                    <h3>Fetch Settings</h3>
                    <p style="font-size:11px;color:#888">Reduce these values to generate fewer tasks</p>

                    <fieldset style="margin-bottom:10px">
                        <legend>Comments Fetching</legend>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Max post age (days):</span>
                            <input type="number" id="set_comments_max_post_age_days" style="width:80px" value="30">
                            <small style="color:#888">(0 = disabled)</small>
                        </label>
                    </fieldset>

                    <fieldset style="margin-bottom:10px">
                        <legend>Likes Fetching</legend>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Max post age (days):</span>
                            <input type="number" id="set_likes_max_post_age_days" style="width:80px" value="30">
                            <small style="color:#888">(0 = disabled)</small>
                        </label>
                        <label style="display:block;margin:5px 0">
                            <input type="checkbox" id="set_likes_fetch_comments">
                            <span>Also fetch likes for comments</span>
                        </label>
                    </fieldset>

                    <fieldset style="margin-bottom:10px">
                        <legend>Other Communities</legend>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Min shared members:</span>
                            <input type="number" id="set_min_shared_members" style="width:80px" value="10">
                            <small style="color:#888">(default 10)</small>
                        </label>
                    </fieldset>

                    <fieldset style="margin-bottom:10px">
                        <legend>Stale Times (hours)</legend>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Members/Posts/Leaderboard:</span>
                            <input type="number" id="set_stale_base" style="width:80px" value="24">
                            <small style="color:#888">(default 24)</small>
                        </label>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Profiles:</span>
                            <input type="number" id="set_stale_profile" style="width:80px" value="168">
                            <small style="color:#888">(default 168 = 7d)</small>
                        </label>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Comments:</span>
                            <input type="number" id="set_stale_comments" style="width:80px" value="168">
                            <small style="color:#888">(default 168 = 7d)</small>
                        </label>
                    </fieldset>

                    <fieldset>
                        <legend>Cutoffs (days)</legend>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Max post age:</span>
                            <input type="number" id="set_max_post_age_days" style="width:80px" value="90">
                            <small style="color:#888">(default 90)</small>
                        </label>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Max user inactive:</span>
                            <input type="number" id="set_max_user_inactive_days" style="width:80px" value="90">
                            <small style="color:#888">(default 90)</small>
                        </label>
                    </fieldset>

                    <div style="margin-top:15px">
                        <button onclick="saveFetchSettings()">Save Settings</button>
                        <span id="settings-status" style="margin-left:10px;color:#0f0"></span>
                    </div>
                </div>
            </div>
        </main>

        <main id="rawdata" style="display: none">
            <button onclick="loadRawData()">Load Fetches</button>
            <div id="rawdata-target"></div>
        </main>

        <main id="data" style="display: none">
            <div style="margin-bottom:10px">
                <button onclick="extractAll()">Extract All</button>
                |
                <button onclick="showOverview()">Overview</button>
                <button onclick="showDataTab('users')">Users</button>
                <button onclick="showDataTab('posts')">Posts</button>
                <button onclick="showDataTab('profiles')">Profiles</button>
            </div>
            <div id="data-content"></div>
        </main>

    </body>
</html>