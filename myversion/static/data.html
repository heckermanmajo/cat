<html>
    <head>
        <script src="entity.js"></script>
        <script src="/entities/config_entry.js"></script>
        <script src="/lib.js"></script>
        <link href="/default.css" type="text/css" rel="stylesheet">
        <script>
            let currentView = "fetchqueue";
            window.onload = async () => {
               lib.setupThemeOnLoad().then();
               currentView = (await ConfigEntry.get('data.currentView') ) || currentView;
               nav(currentView);
            }
            function nav(path){
                ConfigEntry.set('data.currentView', path).then();
                document.querySelectorAll("main").forEach((el) => el.style.display = 'none' );
                let el = document.getElementById(path)
                el.style.display = 'block';
            }
            async function generateQueue(){
                const res = await fetch('/api/fetch-tasks');
                const tasks = await res.json();
                const target = document.getElementById('fetchqueue-target');
                if(!tasks.length){ target.innerHTML = '<p>Keine Tasks</p>'; return; }
                let html = `<b>${tasks.length} Tasks</b><br><table><tr><th>Type</th><th>Community</th><th>Page</th><th>User Skool ID</th><th>User Name</th><th>Post Skool ID</th><th>Post Name</th></tr>`;
                for (const t of tasks) {
                    html += `<tr>
                        <td>${t.type}</td>
                        <td>${t.communitySlug}</td>
                        <td>${t.pageParam || '-'}</td>
                        <td><small>${t.userSkoolHexId || '-'}</small></td>
                        <td>${t.userName || '-'}</td>
                        <td><small>${t.postSkoolHexId || '-'}</small></td>
                        <td>${t.postName || '-'}</td>
                    </tr>`;
                }
                target.innerHTML = html + '</table>';
            }
            async function loadRawData(){
                const res = await fetch('/api/fetch');
                const data = await res.json();
                const target = document.getElementById('rawdata-target');
                if(!data.length){ target.innerHTML = '<p>Keine Fetches vorhanden</p>'; return; }
                let html = '';
                for (const f of data) {
                    const raw_data = JSON.stringify(JSON.parse(f.raw_data), null, 2);
                    html+= `<div style="border:1px solid #333; margin:5px; padding:10px;">
                        <b>#${f.id}</b> | ${f.type} | ${f.community_slug} | page ${f.page_param} | ${f.status} |
                        ${f.error_message ? `<br><small style="color:red">${f.error_message}</small>` : ''}
                        <small>${new Date(f.created_at * 1000).toLocaleString()}</small>
                        <details><summary>Raw Data</summary><pre style="max-height:200px;overflow:auto;font-size:11px">${raw_data}</pre></details>
                    </div>`;
                }
                target.innerHTML = html;
            }

            async function showDataTab(tab){
                const target = document.getElementById('data-content');
                if(tab === 'users'){
                    const res = await fetch('/api/user');
                    const data = await res.json();
                    if(!data.length){ target.innerHTML = '<p>Keine Users vorhanden</p>'; return; }
                    let html = '<table><tr><th>ID</th><th>Skool ID</th><th>Name</th><th>Email</th><th>Role</th><th>Community</th><th>Fetched</th></tr>';
                    for (const u of data) {
                        html += `<tr>
                            <td>${u.id}</td>
                            <td><small>${u.skool_id}</small></td>
                            <td>${u.name}</td>
                            <td>${u.email}</td>
                            <td>${u.member_role}</td>
                            <td>${u.community_slug}</td>
                            <td><small>${new Date(u.fetched_at * 1000).toLocaleString()}</small></td>
                        </tr>`;
                    }
                    target.innerHTML = html + '</table>';
                }
                if(tab === 'posts'){
                    const res = await fetch('/api/post');
                    const data = await res.json();
                    if(!data.length){ target.innerHTML = '<p>Keine Posts vorhanden</p>'; return; }
                    let html = '<table><tr><th>ID</th><th>Skool ID</th><th>Title</th><th>Author</th><th>Type</th><th>Community</th><th>Fetched</th></tr>';
                    for (const p of data) {
                        const meta = p.metadata ? JSON.parse(p.metadata) : {};
                        html += `<tr>
                            <td>${p.id}</td>
                            <td><small>${p.skool_id}</small></td>
                            <td>${meta.title || p.name}</td>
                            <td>${p.user_name}</td>
                            <td>${p.post_type}</td>
                            <td>${p.community_slug}</td>
                            <td><small>${new Date(p.fetched_at * 1000).toLocaleString()}</small></td>
                        </tr>`;
                    }
                    target.innerHTML = html + '</table>';
                }
                if(tab === 'profiles'){
                    const res = await fetch('/api/profile');
                    const data = await res.json();
                    if(!data.length){ target.innerHTML = '<p>Keine Profiles vorhanden</p>'; return; }
                    let html = '<table><tr><th>ID</th><th>Skool ID</th><th>Name</th><th>Posts</th><th>Followers</th><th>Following</th><th>Contributions</th><th>Fetched</th></tr>';
                    for (const p of data) {
                        html += `<tr>
                            <td>${p.id}</td>
                            <td><small>${p.skool_id}</small></td>
                            <td>${p.name}</td>
                            <td>${p.total_posts}</td>
                            <td>${p.total_followers}</td>
                            <td>${p.total_following}</td>
                            <td>${p.total_contributions}</td>
                            <td><small>${new Date(p.fetched_at * 1000).toLocaleString()}</small></td>
                        </tr>`;
                    }
                    target.innerHTML = html + '</table>';
                }
            }

            async function extractAll(){
                const res = await fetch('/api/extract-all', {method: 'POST'});
                const data = await res.json();
                alert(`Extrahiert: ${data.users} Users, ${data.posts} Posts, ${data.profiles} Profiles`);
            }
        </script>
        <title>Cat</title>
    </head>
    <body>

        <header style="height: 30px">

            <select id="viewSelection" onchange="window.location.href=this.value">
                <option value="/members.html"> MEMBERS </option>
                <option value="/posts.html"> POSTS </option>
                <option value="/communities.html"> COMMUNITIES </option>
                <option value="/chats.html" > CHATS </option>
                <option value="/prompts.html"> PROMPTS </option>
                <option value="/data.html" selected> DATABASE </option>
            </select>

            <button onclick="nav('fetchqueue')"> Fetch-Queue </button>
            <button onclick="nav('rawdata')"> Raw Data </button>
            <button onclick="nav('data')"> Data </button>

            <nav style="float: right">
                <select>
                    <option>Community name1</option>
                    <option>Community name2</option>
                    <option>Community name3</option>
                    <option>Community name4</option>
                </select>
                <select id="themeSelection" onchange="setTheme(this.value).then()">
                    <option value="blue"> Blue </option>
                    <option value="red"> Red </option>
                </select>
            </nav>

        </header>

        <main id="fetchqueue" style="display: none">
            <button onclick="generateQueue()">Generate QUEUE</button>
            <div id='fetchqueue-target'></div>
        </main>

        <main id="rawdata" style="display: none">
            <button onclick="loadRawData()">Load Fetches</button>
            <div id="rawdata-target"></div>
        </main>

        <main id="data" style="display: none">
            <div style="margin-bottom:10px">
                <button onclick="extractAll()">Extract All</button>
                |
                <button onclick="showDataTab('users')">Users</button>
                <button onclick="showDataTab('posts')">Posts</button>
                <button onclick="showDataTab('profiles')">Profiles</button>
            </div>
            <div id="data-content"></div>
        </main>

    </body>
</html>