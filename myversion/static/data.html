<html>
    <head>
        <script src="entity.js"></script>
        <script src="/entities/config_entry.js"></script>
        <script src="/lib.js"></script>
        <link href="/default.css" type="text/css" rel="stylesheet">
        <script>
            let currentView = "fetchqueue";
            window.onload = async () => {
               lib.showLoading('waking up');
               lib.setupThemeOnLoad().then();
               currentView = (await ConfigEntry.get('data.currentView') ) || currentView;
               nav(currentView);
               await loadFetchSettings();
               lib.hideLoading();
            }

            async function loadFetchSettings(){
                const keys = [
                    'comments_max_post_age_days',
                    'likes_max_post_age_days', 'likes_fetch_comments',
                    'min_shared_members',
                    'stale_base', 'stale_profile', 'stale_comments',
                    'max_post_age_days', 'max_user_inactive_days',
                    'error_404_max_failures', 'error_404_cooldown_hours'
                ];
                for(const key of keys){
                    const val = await ConfigEntry.get(key);
                    const el = document.getElementById('set_' + key);
                    if(!el) continue;
                    if(el.type === 'checkbox'){
                        el.checked = val === 'true';
                    } else if(val){
                        el.value = val;
                    }
                }
            }

            async function saveFetchSettings(){
                const settings = {
                    'comments_max_post_age_days': document.getElementById('set_comments_max_post_age_days').value,
                    'likes_max_post_age_days': document.getElementById('set_likes_max_post_age_days').value,
                    'likes_fetch_comments': document.getElementById('set_likes_fetch_comments').checked ? 'true' : 'false',
                    'min_shared_members': document.getElementById('set_min_shared_members').value,
                    'stale_base': document.getElementById('set_stale_base').value,
                    'stale_profile': document.getElementById('set_stale_profile').value,
                    'stale_comments': document.getElementById('set_stale_comments').value,
                    'max_post_age_days': document.getElementById('set_max_post_age_days').value,
                    'max_user_inactive_days': document.getElementById('set_max_user_inactive_days').value,
                    'error_404_max_failures': document.getElementById('set_error_404_max_failures').value,
                    'error_404_cooldown_hours': document.getElementById('set_error_404_cooldown_hours').value,
                };
                for(const [key, val] of Object.entries(settings)){
                    await ConfigEntry.set(key, val);
                }
                document.getElementById('settings-status').textContent = 'Saved!';
                setTimeout(() => document.getElementById('settings-status').textContent = '', 2000);
            }
            function nav(path){
                ConfigEntry.set('data.currentView', path).then();
                document.querySelectorAll("main").forEach((el) => el.style.display = 'none' );
                let el = document.getElementById(path)
                el.style.display = 'block';
            }
            async function resetFailedAbout(){
                const res = await fetch('/api/reset-failed-about', {method: 'POST'});
                const data = await res.json();
                alert('Reset: ' + data.reset + ' communities\n' + (data.slugs || []).join(', '));
                generateQueue();
            }

            async function generateQueue(){
                lib.showLoading();
                const res = await fetch('/api/fetch-tasks');
                const tasks = await res.json();
                lib.hideLoading();
                const target = document.getElementById('fetchqueue-target');
                if(!tasks.length){ target.innerHTML = '<p>Keine Tasks</p>'; return; }
                // Count tasks by type
                const typeCounts = {};
                for (const t of tasks) { typeCounts[t.type] = (typeCounts[t.type] || 0) + 1; }
                const summary = Object.entries(typeCounts).map(([type, count]) => `(${count}) ${type}`).join(' ');
                let html = `<b>${tasks.length} Tasks:</b> ${summary}<br><table><tr><th>Type</th><th>Community</th><th>Comment</th><th>Page</th><th>User</th><th>Post</th></tr>`;
                for (const t of tasks) {
                    html += `<tr>
                        <td>${t.type}</td>
                        <td>${t.communitySlug}</td>
                        <td><small>${t.comment || '-'}</small></td>
                        <td>${t.pageParam || '-'}</td>
                        <td>${t.userName || '-'}</td>
                        <td>${t.postName || '-'}</td>
                    </tr>`;
                }
                target.innerHTML = html + '</table>';
            }
            let rawdataPage = 1;
            const rawdataLimit = 100;

            async function loadRawData(page = 1){
                lib.showLoading();
                rawdataPage = page;
                const res = await fetch(`/api/fetch/paginated?page=${page}&limit=${rawdataLimit}`);
                const data = await res.json();
                lib.hideLoading();
                const target = document.getElementById('rawdata-target');
                if(!data.items.length){ target.innerHTML = '<p>Keine Fetches vorhanden</p>'; return; }
                let html = renderPagination(data);
                for (const f of data.items) {
                    const raw_data = JSON.stringify(JSON.parse(f.raw_data), null, 2);
                    html+= `<div style="border:1px solid #333; margin:5px; padding:10px;">
                        <b>#${f.id}</b> | ${f.type} | ${f.community_slug} | page ${f.page_param} | ${f.status} |
                        ${f.error_message ? `<br><small style="color:red">${f.error_message}</small>` : ''}
                        <small>${new Date(f.created_at * 1000).toLocaleString()}</small>
                        <details><summary>Raw Data</summary><pre style="max-height:200px;overflow:auto;font-size:11px">${raw_data}</pre></details>
                    </div>`;
                }
                html += renderPagination(data);
                target.innerHTML = html;
            }

            function renderPagination(data){
                const {page, pages, total} = data;
                if(pages <= 1) return '';
                let html = `<div style="margin:10px 0;display:flex;gap:5px;align-items:center;">`;
                html += `<span>Total: ${total} | Seite ${page}/${pages}</span>`;
                html += `<button onclick="loadRawData(1)" ${page===1?'disabled':''}>Â«</button>`;
                html += `<button onclick="loadRawData(${page-1})" ${page===1?'disabled':''}>â€¹</button>`;
                const start = Math.max(1, page - 2);
                const end = Math.min(pages, page + 2);
                for(let i = start; i <= end; i++){
                    html += `<button onclick="loadRawData(${i})" ${i===page?'style="font-weight:bold"':''}>${i}</button>`;
                }
                html += `<button onclick="loadRawData(${page+1})" ${page===pages?'disabled':''}>â€º</button>`;
                html += `<button onclick="loadRawData(${pages})" ${page===pages?'disabled':''}>Â»</button>`;
                html += `</div>`;
                return html;
            }

            async function showOverview(){
                lib.showLoading();
                const res = await fetch('/api/database/overview');
                const data = await res.json();
                lib.hideLoading();
                const target = document.getElementById('data-content');
                if(!data.length){ target.innerHTML = '<p>Keine Tabellen vorhanden</p>'; return; }
                let total = data.reduce((sum, t) => sum + t.count, 0);
                let html = `<h3>Database Overview</h3><p>Total: ${total} entries</p><table><tr><th>Table</th><th>Entries</th></tr>`;
                for (const t of data) {
                    html += `<tr><td>${t.name}</td><td>${t.count}</td></tr>`;
                }
                target.innerHTML = html + '</table>';
            }

            async function showDataTab(tab){
                lib.showLoading();
                const target = document.getElementById('data-content');
                if(tab === 'users'){
                    const res = await fetch('/api/user');
                    const data = await res.json();
                    if(!data.length){ target.innerHTML = '<p>Keine Users vorhanden</p>'; return; }
                    let html = '<table><tr><th>ID</th><th>Skool ID</th><th>Name</th><th>Email</th><th>Role</th><th>Community</th><th>Fetched</th></tr>';
                    for (const u of data) {
                        html += `<tr>
                            <td>${u.id}</td>
                            <td><small>${u.skool_id}</small></td>
                            <td>${u.name}</td>
                            <td>${u.email}</td>
                            <td>${u.member_role}</td>
                            <td>${u.community_slug}</td>
                            <td><small>${new Date(u.fetched_at * 1000).toLocaleString()}</small></td>
                        </tr>`;
                    }
                    target.innerHTML = html + '</table>';
                }
                if(tab === 'posts'){
                    const res = await fetch('/api/post/latest');
                    const data = await res.json();
                    if(!data.length){ target.innerHTML = '<p>Keine Posts vorhanden</p>'; return; }
                    let html = '<table><tr><th>ID</th><th>Skool ID</th><th>Title</th><th>Author</th><th>Type</th><th>Community</th><th>Fetched</th></tr>';
                    for (const p of data) {
                        const meta = p.metadata ? JSON.parse(p.metadata) : {};
                        html += `<tr>
                            <td>${p.id}</td>
                            <td><small>${p.skool_id}</small></td>
                            <td>${meta.title || p.name}</td>
                            <td>${p.user_name}</td>
                            <td>${p.post_type}</td>
                            <td>${p.community_slug}</td>
                            <td><small>${new Date(p.fetched_at * 1000).toLocaleString()}</small></td>
                        </tr>`;
                    }
                    target.innerHTML = html + '</table>';
                }
                if(tab === 'profiles'){
                    const res = await fetch('/api/profile');
                    const data = await res.json();
                    if(!data.length){ target.innerHTML = '<p>Keine Profiles vorhanden</p>'; return; }
                    let html = '<table><tr><th>ID</th><th>Skool ID</th><th>Name</th><th>Posts</th><th>Followers</th><th>Following</th><th>Contributions</th><th>Fetched</th></tr>';
                    for (const p of data) {
                        html += `<tr>
                            <td>${p.id}</td>
                            <td><small>${p.skool_id}</small></td>
                            <td>${p.name}</td>
                            <td>${p.total_posts}</td>
                            <td>${p.total_followers}</td>
                            <td>${p.total_following}</td>
                            <td>${p.total_contributions}</td>
                            <td><small>${new Date(p.fetched_at * 1000).toLocaleString()}</small></td>
                        </tr>`;
                    }
                    target.innerHTML = html + '</table>';
                }
                lib.hideLoading();
            }

            // ============================================================================
            // ELECTRON FETCHER
            // ============================================================================

            let fetcherTasks = [];
            let fetcherRunning = false;
            let fetcherPaused = false;
            let fetcherCurrentIndex = 0;
            let fetcherShouldStop = false;

            function fetcherLog(msg, type = 'info') {
                const log = document.getElementById('fetcher-log');
                const time = new Date().toLocaleTimeString();
                const colors = { info: '#8b949e', ok: '#3fb950', error: '#f85149', warn: '#d29922' };
                log.innerHTML += `<div style="color:${colors[type] || colors.info}">[${time}] ${msg}</div>`;
                log.scrollTop = log.scrollHeight;
            }

            function fetcherUpdateStatus(electronOk, skoolLoggedIn) {
                const elStatus = document.getElementById('fetcher-electron-status');
                const skStatus = document.getElementById('fetcher-skool-status');

                if (electronOk) {
                    elStatus.innerHTML = '<span style="color:#3fb950">Electron: Connected</span>';
                } else {
                    elStatus.innerHTML = '<span style="color:#f85149">Electron: Not available - Start app via ./e.sh</span>';
                }

                if (skoolLoggedIn) {
                    skStatus.innerHTML = '<span style="color:#3fb950">Skool: Logged in</span>';
                    document.getElementById('btn-skool-hide').disabled = false;
                } else {
                    skStatus.innerHTML = '<span style="color:#d29922">Skool: Not logged in</span>';
                }
            }

            async function fetcherInit() {
                if (typeof window.electronFetcher === 'undefined') {
                    fetcherUpdateStatus(false, false);
                    fetcherLog('Electron not available - start with ./e.sh', 'warn');
                    return;
                }
                fetcherUpdateStatus(true, false);
                fetcherLog('Electron detected', 'ok');

                const status = await window.electronFetcher.checkSkoolLogin();
                fetcherUpdateStatus(true, status.loggedIn);
                if (status.loggedIn) {
                    fetcherLog('Already logged in to Skool', 'ok');
                }
            }

            async function fetcherShowLogin() {
                if (!window.electronFetcher) { fetcherLog('Electron not available', 'error'); return; }
                fetcherLog('Opening Skool Login...');
                await window.electronFetcher.showSkoolLogin();
                document.getElementById('btn-skool-hide').disabled = false;
                document.getElementById('skool-close-overlay').style.display = 'flex';
            }

            async function fetcherHideSkool() {
                if (!window.electronFetcher) return;
                await window.electronFetcher.hideSkool();
                fetcherLog('Skool hidden');
                document.getElementById('btn-skool-hide').disabled = true;
                document.getElementById('skool-close-overlay').style.display = 'none';
            }

            async function fetcherCheckLogin() {
                if (!window.electronFetcher) { fetcherLog('Electron not available', 'error'); return; }
                fetcherLog('Checking login status...');
                const status = await window.electronFetcher.checkSkoolLogin();
                fetcherUpdateStatus(true, status.loggedIn);
                fetcherLog(status.loggedIn ? 'Logged in!' : 'Not logged in', status.loggedIn ? 'ok' : 'warn');
            }

            async function fetcherLoadTasks() {
                fetcherLog('Loading tasks from server...');
                const res = await fetch('/api/fetch-tasks');
                fetcherTasks = await res.json();
                fetcherCurrentIndex = 0;

                const tasksDiv = document.getElementById('fetcher-tasks');
                if (!fetcherTasks.length) {
                    tasksDiv.innerHTML = '<p style="color:#888">No tasks available</p>';
                    fetcherLog('No tasks', 'warn');
                    return;
                }

                const counts = {};
                for (const t of fetcherTasks) { counts[t.type] = (counts[t.type] || 0) + 1; }
                const summary = Object.entries(counts).map(([k,v]) => `${v}x ${k}`).join(', ');

                let html = `<p><b>${fetcherTasks.length} Tasks:</b> ${summary}</p>`;
                html += '<div style="font-size:11px; max-height:200px; overflow-y:auto;">';
                for (let i = 0; i < fetcherTasks.length; i++) {
                    const t = fetcherTasks[i];
                    let info = t.communitySlug;
                    if (t.type === 'profile') info += ' @' + t.userName;
                    else if (t.type === 'comments' || t.type === 'likes') info += ' ' + (t.postName || t.postSkoolHexId);
                    else if (t.pageParam) info += ' p' + t.pageParam;
                    html += `<div id="task-${i}" style="padding:3px; border-bottom:1px solid #333;">${t.type}: ${info}</div>`;
                }
                html += '</div>';
                tasksDiv.innerHTML = html;

                fetcherLog(`${fetcherTasks.length} tasks loaded (${summary})`, 'ok');
                document.getElementById('btn-start').disabled = false;
            }

            async function fetcherStart() {
                if (!window.electronFetcher) { fetcherLog('Electron not available', 'error'); return; }

                const status = await window.electronFetcher.checkSkoolLogin();
                if (!status.loggedIn) {
                    fetcherLog('Please login to Skool first!', 'error');
                    return;
                }

                if (fetcherTasks.length === 0) {
                    fetcherLog('No tasks loaded', 'error');
                    return;
                }

                // Delay validieren (minimum 5)
                const delayInput = document.getElementById('fetcher-delay');
                if (parseInt(delayInput.value) < 5) {
                    delayInput.value = 5;
                }

                fetcherRunning = true;
                fetcherPaused = false;
                fetcherShouldStop = false;

                document.getElementById('btn-start').disabled = true;
                document.getElementById('btn-pause').disabled = false;
                document.getElementById('btn-stop').disabled = false;
                document.getElementById('btn-load-tasks').disabled = true;

                lib.showLoading('fetching', {
                    showProgress: true,
                    warning: 'Please do not leave this page!',
                    onCancel: fetcherStop
                });
                lib.updateLoadingProgress(0, fetcherTasks.length);

                fetcherLog('Starting fetch...', 'ok');
                await fetcherRun();
            }

            async function fetcherRun() {
                const delay = parseInt(document.getElementById('fetcher-delay').value) * 1000;
                const total = fetcherTasks.length;

                while (fetcherCurrentIndex < fetcherTasks.length) {
                    if (fetcherShouldStop) {
                        fetcherLog('Stopped', 'warn');
                        lib.hideLoading();
                        break;
                    }
                    if (fetcherPaused) {
                        fetcherLog('Paused at task ' + (fetcherCurrentIndex + 1), 'warn');
                        lib.hideLoading();
                        return;
                    }

                    const task = fetcherTasks[fetcherCurrentIndex];
                    const taskEl = document.getElementById('task-' + fetcherCurrentIndex);
                    if (taskEl) taskEl.style.background = '#1f3a1f';

                    // Progress
                    const percent = Math.round(((fetcherCurrentIndex + 1) / total) * 100);
                    document.getElementById('fetcher-progress').value = percent;
                    document.getElementById('fetcher-progress-text').textContent =
                        `Task ${fetcherCurrentIndex + 1} / ${total} (${percent}%)`;

                    // Overlay Progress updaten
                    lib.updateLoadingProgress(fetcherCurrentIndex + 1, total);

                    // Zur Community navigieren (fÃ¼r buildId)
                    fetcherLog(`[${fetcherCurrentIndex + 1}/${total}] ${task.type}: ${task.communitySlug}...`);
                    await window.electronFetcher.navigateSkool(`https://www.skool.com/${task.communitySlug}`);

                    // Task ausfÃ¼hren
                    const result = await window.electronFetcher.executeFetchTask(task);

                    if (result.error) {
                        fetcherLog(`ERROR: ${result.error}`, 'error');
                        if (taskEl) taskEl.style.background = '#3a1f1f';
                    } else {
                        fetcherLog(`OK`, 'ok');
                        if (taskEl) taskEl.style.background = '#1f3a1f';
                    }

                    // Ergebnis an Server senden
                    const taskResult = { task, result };
                    try {
                        await fetch('/api/fetch-result', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ results: [taskResult] })
                        });
                    } catch (e) {
                        fetcherLog(`Server-Error: ${e.message}`, 'error');
                    }

                    fetcherCurrentIndex++;

                    // Delay
                    if (fetcherCurrentIndex < fetcherTasks.length && !fetcherShouldStop && !fetcherPaused) {
                        await new Promise(r => setTimeout(r, delay));
                    }
                }

                lib.hideLoading();
                if (!fetcherShouldStop && !fetcherPaused) {
                    fetcherLog(`Done! ${fetcherCurrentIndex} tasks completed`, 'ok');
                    document.getElementById('fetcher-progress-text').textContent = 'Done!';
                }

                fetcherRunning = false;
                document.getElementById('btn-start').disabled = false;
                document.getElementById('btn-pause').disabled = true;
                document.getElementById('btn-stop').disabled = true;
                document.getElementById('btn-load-tasks').disabled = false;
            }

            function fetcherPause() {
                fetcherPaused = true;
                document.getElementById('btn-start').textContent = 'Resume';
                document.getElementById('btn-start').disabled = false;
                document.getElementById('btn-pause').disabled = true;
            }

            function fetcherStop() {
                fetcherShouldStop = true;
                fetcherPaused = false;
                fetcherRunning = false;
                fetcherCurrentIndex = 0;
                lib.hideLoading();
                document.getElementById('btn-start').textContent = 'Start';
                document.getElementById('btn-start').disabled = false;
                document.getElementById('btn-pause').disabled = true;
                document.getElementById('btn-stop').disabled = true;
                document.getElementById('btn-load-tasks').disabled = false;
            }

            // Init beim Laden
            setTimeout(fetcherInit, 500);

            // ============================================================================
            // LOGS
            // ============================================================================
            async function loadLogs(){
                lib.showLoading();
                const res = await fetch('/api/logs');
                const logs = await res.json();
                lib.hideLoading();
                const target = document.getElementById('logs-content');
                if(!logs.length){
                    target.innerHTML = '<p style="color:#888">No logs available</p>';
                    return;
                }
                const colors = { INFO: '#8b949e', ERROR: '#f85149', WARN: '#d29922', OK: '#3fb950' };
                let html = '';
                for (const line of logs) {
                    let color = colors.INFO;
                    for (const [level, c] of Object.entries(colors)) {
                        if (line.includes(`[${level}]`)) { color = c; break; }
                    }
                    html += `<div style="color:${color}; margin:2px 0;">${line}</div>`;
                }
                target.innerHTML = html;
                document.getElementById('logs-status').textContent = `${logs.length} entries`;
            }

            async function clearLogs(){
                if(!confirm('Clear all logs?')) return;
                await fetch('/api/logs/clear', {method: 'POST'});
                document.getElementById('logs-content').innerHTML = '<p style="color:#888">Logs cleared</p>';
                document.getElementById('logs-status').textContent = 'Cleared';
            }

            if (window.electronFetcher && window.electronFetcher.onSkoolHidden) {
                window.electronFetcher.onSkoolHidden(() => {
                    document.getElementById('skool-close-overlay').style.display = 'none';
                    document.getElementById('btn-skool-hide').disabled = true;
                    fetcherLog('Skool closed (Escape)', 'info');
                });
            }

            async function extractAll(){
                // Dialog erstellen
                const dialog = document.createElement('dialog');
                dialog.style.cssText = 'min-width: 500px; min-height: 400px; padding: 40px;';
                dialog.innerHTML = `
                    <style>
                        .cat-container { position: relative; width: 400px; height: 180px; overflow: hidden; margin: 0 auto; }
                        .floating-cat { position: absolute; font-size: 3rem; animation: floatUp 2.5s ease-out forwards; }
                        @keyframes floatUp {
                            0% { transform: translateY(150px) scale(0.5); opacity: 0; }
                            20% { opacity: 1; }
                            80% { opacity: 1; }
                            100% { transform: translateY(-80px) scale(1.3); opacity: 0; }
                        }
                        .extract-text { text-align: center; font-size: 2rem; margin: 20px 0; }
                        .dots::after { content: ''; animation: dots 1.5s infinite; }
                        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
                    </style>
                    <div class="cat-container" id="ext-cat-container"></div>
                    <div class="extract-text"><span id="ext-cat-text">hunting</span><span class="dots"></span></div>
                    <p style="color:orange;text-align:center;font-size:1.2rem;margin:20px 0"><b>Don't close this window!</b></p>
                    <div id="ext-progress-text" style="text-align:center;font-size:1.3rem;margin:15px 0">Starting...</div>
                    <progress id="ext-progress-bar" value="0" max="100" style="width:100%;height:25px"></progress>
                    <div id="ext-stats" style="margin-top:20px;font-size:1.1rem;text-align:center"></div>
                `;
                document.body.appendChild(dialog);
                dialog.showModal();

                // Cat animation
                const catEmojis = ['ðŸ±', 'ðŸ˜º', 'ðŸ˜¸', 'ðŸ˜¹', 'ðŸ˜»', 'ðŸ˜¼', 'ðŸ˜½', 'ðŸ™€', 'ðŸ˜¿', 'ðŸ˜¾', 'ðŸˆ', 'ðŸˆâ€â¬›'];
                const catTexts = ['thinking', 'doodling', 'miauing', 'purring', 'extracting', 'hunting', 'grooming', 'exploring'];
                const catContainer = dialog.querySelector('#ext-cat-container');
                const catTextEl = dialog.querySelector('#ext-cat-text');
                const spawnCat = () => {
                    const cat = document.createElement('span');
                    cat.className = 'floating-cat';
                    cat.textContent = catEmojis[Math.floor(Math.random() * catEmojis.length)];
                    cat.style.left = (Math.random() * 340 + 30) + 'px';
                    catContainer.appendChild(cat);
                    setTimeout(() => cat.remove(), 2500);
                };
                spawnCat();
                const catInterval = setInterval(spawnCat, 300);
                const textInterval = setInterval(() => {
                    catTextEl.textContent = catTexts[Math.floor(Math.random() * catTexts.length)];
                }, 2000);

                // Info holen
                const info = await fetch('/api/extract-info').then(r => r.json());
                const total = info.total;
                if(total === 0){
                    clearInterval(catInterval);
                    clearInterval(textInterval);
                    dialog.innerHTML = `
                        <div style="text-align:center">
                            <h2 style="font-size:2rem;margin-bottom:30px">ðŸ˜¿ No fetches available</h2>
                            <button onclick="this.closest('dialog').close()" style="padding:10px 30px;font-size:1.2rem">OK</button>
                        </div>
                    `;
                    return;
                }
                const batchSize = 50;

                // Batches durchlaufen
                let processed = 0;
                let totals = {users: 0, posts: 0, comments: 0, profiles: 0, leaderboard: 0, other_communities: 0};

                while(processed < total){
                    const res = await fetch('/api/extract-batch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({offset: processed, limit: batchSize})
                    }).then(r => r.json());

                    processed += res.processed;
                    totals.users += res.extracted.users;
                    totals.posts += res.extracted.posts;
                    totals.comments += res.extracted.comments;
                    totals.profiles += res.extracted.profiles;
                    totals.leaderboard += res.extracted.leaderboard;
                    totals.other_communities += res.extracted.other_communities;

                    // Progress updaten
                    const percent = Math.round((processed / total) * 100);
                    dialog.querySelector('#ext-progress-bar').value = percent;
                    dialog.querySelector('#ext-progress-text').textContent = `${processed} / ${total} Fetches (${percent}%)`;
                    dialog.querySelector('#ext-stats').innerHTML = `Users: ${totals.users} | Posts: ${totals.posts} | Comments: ${totals.comments} | Profiles: ${totals.profiles}`;
                }

                // Fertig - Intervals stoppen
                clearInterval(catInterval);
                clearInterval(textInterval);
                dialog.innerHTML = `
                    <div style="text-align:center">
                        <h2 style="font-size:2.5rem;margin-bottom:20px">ðŸ˜º Done!</h2>
                        <p style="font-size:1.2rem;margin-bottom:20px">Extracted:</p>
                        <ul style="list-style:none;padding:0;font-size:1.3rem;line-height:2">
                            <li><b>${totals.users}</b> Users</li>
                            <li><b>${totals.posts}</b> Posts</li>
                            <li><b>${totals.comments}</b> Comments</li>
                            <li><b>${totals.profiles}</b> Profiles</li>
                            <li><b>${totals.leaderboard}</b> Leaderboard</li>
                            <li><b>${totals.other_communities}</b> Other Communities</li>
                        </ul>
                        <button onclick="this.closest('dialog').close()" style="margin-top:20px;padding:10px 30px;font-size:1.2rem">OK</button>
                    </div>
                `;
            }
        </script>
        <title>Cat</title>
    </head>
    <body>

        <div id="skool-close-overlay" style="display:none; position:fixed; top:10px; left:50px; right:50px; height:60px; background:#1a1a1a; border:2px solid #f85149; border-radius:8px; z-index:9999; align-items:center; justify-content:space-between; padding:0 20px;">
            <span style="color:#fff; font-size:16px;">Skool Login - Close after logging in</span>
            <button onclick="fetcherHideSkool()" style="background:#f85149; color:#fff; border:none; padding:12px 24px; font-size:16px; cursor:pointer; border-radius:5px;">
                CLOSE (or ESC)
            </button>
        </div>

        
        <header style="height: 30px">

            <select id="viewSelection" onchange="window.location.href=this.value">
                <option value="/members.html"> MEMBERS </option>
                <option value="/posts.html"> POSTS </option>
                <option value="/communities.html"> COMMUNITIES </option>
                <option value="/chats.html" > CHATS </option>
                <option value="/prompts.html"> PROMPTS </option>
                <option value="/data.html" selected> DATABASE </option>
            </select>

            <button onclick="nav('fetcher')"> Fetcher </button>
            <button onclick="nav('fetchqueue')"> Fetch-Queue </button>
            <button onclick="nav('rawdata')"> Raw Data </button>
            <button onclick="nav('data')"> Data </button>
            <button onclick="nav('logs')"> Logs </button>

            <nav style="float: right">
                <select>
                    <option>Community name1</option>
                    <option>Community name2</option>
                    <option>Community name3</option>
                    <option>Community name4</option>
                </select>
                <select id="themeSelection" onchange="lib.setTheme(this.value).then()">
                    <option value="blue"> Blue </option>
                    <option value="red"> Red </option>
                    <option value="purple"> Purple </option>
                    <option value="orange"> Orange </option>
                    <option value="pink"> Pink </option>
                    <option value="cyan"> Cyan </option>
                    <option value="gold"> Gold </option>
                </select>
            </nav>

        </header>

        <main id="fetcher" style="display: none">
            <div style="display:flex; gap:20px;">
                <div style="flex:1">
                    <h3>Electron Fetcher</h3>

                    <div id="fetcher-status" style="padding:15px; margin-bottom:15px; background:#1a1a1a; border:1px solid #444; border-radius:5px;">
                        <div id="fetcher-electron-status">Checking Electron...</div>
                        <div id="fetcher-skool-status" style="margin-top:10px">Skool: Not connected</div>
                    </div>

                    <div style="margin-bottom:15px;">
                        <button onclick="fetcherShowLogin()" id="btn-skool-login">Open Skool Login</button>
                        <button onclick="fetcherHideSkool()" id="btn-skool-hide" disabled>Hide Skool</button>
                        <button onclick="fetcherCheckLogin()" id="btn-skool-check">Check Status</button>
                    </div>

                    <div style="margin-bottom:15px; padding:15px; background:#1a1a1a; border:1px solid #444;">
                        <h4 style="margin:0 0 10px 0">Fetch Control</h4>
                        <button onclick="fetcherLoadTasks()" id="btn-load-tasks">Load Tasks</button>
                        <button onclick="fetcherStart()" id="btn-start" disabled>Start</button>
                        <button onclick="fetcherPause()" id="btn-pause" disabled>Pause</button>
                        <button onclick="fetcherStop()" id="btn-stop" disabled>Stop</button>
                        <div style="margin-top:10px">
                            <label>
                                Delay (seconds):
                                <input type="number" id="fetcher-delay" value="5" min="5" max="30" style="width:60px">
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom:15px;">
                        <div id="fetcher-progress-text">Ready</div>
                        <progress id="fetcher-progress" value="0" max="100" style="width:100%;height:20px;margin-top:5px;"></progress>
                    </div>

                    <div style="max-height:300px; overflow-y:auto; border:1px solid #444; padding:10px;" id="fetcher-tasks">
                        <p style="color:#888">No tasks loaded</p>
                    </div>
                </div>

                <div style="width:400px;">
                    <h3>Log</h3>
                    <div id="fetcher-log" style="height:500px; overflow-y:auto; background:#0d1117; border:1px solid #444; padding:10px; font-family:monospace; font-size:12px;">
                    </div>
                    <button onclick="document.getElementById('fetcher-log').innerHTML=''" style="margin-top:5px">Clear Log</button>
                </div>
            </div>
        </main>

        <main id="fetchqueue" style="display: none">
            <div style="display:flex; gap:20px;">
                <div style="flex:1">
                    <h3>Fetch Queue</h3>
                    <button onclick="generateQueue()">Generate QUEUE</button>
                    <button onclick="resetFailedAbout()">Reset Failed Tasks</button>
                    <div id='fetchqueue-target'></div>
                </div>
                <div style="width:450px; padding:15px; border:1px solid #444; background:#1a1a1a;">
                    <h3>Fetch Settings</h3>
                    <p style="font-size:11px;color:#888">Reduce these values to generate fewer tasks</p>

                    <fieldset style="margin-bottom:10px">
                        <legend>Comments Fetching</legend>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Max post age (days):</span>
                            <input type="number" id="set_comments_max_post_age_days" style="width:80px" value="30">
                            <small style="color:#888">(0 = disabled)</small>
                        </label>
                    </fieldset>

                    <fieldset style="margin-bottom:10px">
                        <legend>Likes Fetching</legend>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Max post age (days):</span>
                            <input type="number" id="set_likes_max_post_age_days" style="width:80px" value="30">
                            <small style="color:#888">(0 = disabled)</small>
                        </label>
                        <label style="display:block;margin:5px 0">
                            <input type="checkbox" id="set_likes_fetch_comments">
                            <span>Also fetch likes for comments</span>
                        </label>
                    </fieldset>

                    <fieldset style="margin-bottom:10px">
                        <legend>Other Communities</legend>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Min shared members:</span>
                            <input type="number" id="set_min_shared_members" style="width:80px" value="10">
                            <small style="color:#888">(default 10)</small>
                        </label>
                    </fieldset>

                    <fieldset style="margin-bottom:10px">
                        <legend>Stale Times (hours)</legend>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Members/Posts/Leaderboard:</span>
                            <input type="number" id="set_stale_base" style="width:80px" value="24">
                            <small style="color:#888">(default 24)</small>
                        </label>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Profiles:</span>
                            <input type="number" id="set_stale_profile" style="width:80px" value="168">
                            <small style="color:#888">(default 168 = 7d)</small>
                        </label>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Comments:</span>
                            <input type="number" id="set_stale_comments" style="width:80px" value="168">
                            <small style="color:#888">(default 168 = 7d)</small>
                        </label>
                    </fieldset>

                    <fieldset style="margin-bottom:10px">
                        <legend>Cutoffs (days)</legend>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Max post age:</span>
                            <input type="number" id="set_max_post_age_days" style="width:80px" value="90">
                            <small style="color:#888">(default 90)</small>
                        </label>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Max user inactive:</span>
                            <input type="number" id="set_max_user_inactive_days" style="width:80px" value="90">
                            <small style="color:#888">(default 90)</small>
                        </label>
                    </fieldset>

                    <fieldset>
                        <legend>404 Error Cooldown</legend>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Max failures before cooldown:</span>
                            <input type="number" id="set_error_404_max_failures" style="width:80px" value="2">
                            <small style="color:#888">(default 2)</small>
                        </label>
                        <label style="display:block;margin:5px 0">
                            <span style="display:inline-block;width:200px">Cooldown (hours):</span>
                            <input type="number" id="set_error_404_cooldown_hours" style="width:80px" value="12">
                            <small style="color:#888">(default 12)</small>
                        </label>
                    </fieldset>

                    <div style="margin-top:15px">
                        <button onclick="saveFetchSettings()">Save Settings</button>
                        <span id="settings-status" style="margin-left:10px;color:#0f0"></span>
                    </div>
                </div>
            </div>
        </main>

        <main id="rawdata" style="display: none">
            <button onclick="loadRawData()">Load Fetches</button>
            <div id="rawdata-target"></div>
        </main>

        <main id="data" style="display: none">
            <div style="margin-bottom:10px">
                <button onclick="extractAll()">Extract All</button>
                |
                <button onclick="showOverview()">Overview</button>
                <button onclick="showDataTab('users')">Users</button>
                <button onclick="showDataTab('posts')">Posts</button>
                <button onclick="showDataTab('profiles')">Profiles</button>
            </div>
            <div id="data-content"></div>
        </main>

        <main id="logs" style="display: none">
            <div style="margin-bottom:10px">
                <button onclick="loadLogs()">Refresh Logs</button>
                <button onclick="clearLogs()">Clear Logs</button>
                <span id="logs-status" style="margin-left:10px;color:#888"></span>
            </div>
            <div id="logs-content" style="background:#0d1117; border:1px solid #444; padding:15px; font-family:monospace; font-size:12px; max-height:600px; overflow-y:auto;">
                <p style="color:#888">Click "Refresh Logs" to load</p>
            </div>
        </main>

    </body>
</html>