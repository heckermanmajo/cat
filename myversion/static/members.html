<!DOCTYPE html>
<html lang="en">
    <head>
        <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="entity.js"></script>
        <script src="/entities/config_entry.js"></script>
        <script src="/entities/user.js"></script>
        <script src="/entities/post.js"></script>
        <script src="/lib.js"></script>
        <link href="/default.css" type="text/css" rel="stylesheet">
        <title>Cat</title>
        <script>

            // =========================================================================
            // Graph Rendering (Vis.js) - Interaktionen zwischen Usern
            // =========================================================================
            /**
             * Lädt und rendert den Interaktions-Graph.
             * Knoten = User mit Profilbild
             * Kanten = Likes (rot) + Comments (blau) zum Post-Autor
             * @param {HTMLElement} container - Container für den Graph
             * @param {Array} filteredMembers - Gefilterte Members (skool_ids werden verwendet)
             */
            async function loadAndRenderInteractionGraph(container, filteredMembers) {
                container.innerHTML = '<p style="padding:20px">Lade Graph-Daten...</p>';

                // POST mit skool_ids der gefilterten Members
                const skoolIds = filteredMembers.map(m => m.skool_id);
                const res = await post('/api/graph/interactions', {
                    skool_ids: skoolIds,
                    community: currentCommunity
                });
                if (!res.ok) {
                    container.innerHTML = '<p style="padding:20px;color:red">Fehler beim Laden der Graph-Daten</p>';
                    return;
                }

                const { nodes, like_edges, comment_edges } = res.data;

                if (nodes.length === 0) {
                    container.innerHTML = '<p style="padding:20px">Keine User gefunden</p>';
                    return;
                }

                // Knoten mit Profilbildern
                const visNodes = nodes.map(n => ({
                    id: n.id,
                    label: n.name,
                    shape: n.picture ? 'circularImage' : 'dot',
                    image: n.picture || undefined,
                    size: 25,
                    title: `@${n.name}\nRole: ${n.role}`,
                    group: n.role,
                    borderWidth: 2
                }));

                // Kanten: Likes (rot) + Comments (blau)
                const visEdges = [
                    ...like_edges.map(e => ({
                        from: e.source,
                        to: e.target,
                        value: e.weight,
                        color: { color: '#e74c3c', highlight: '#c0392b' },
                        title: `${e.weight} Like${e.weight > 1 ? 's' : ''}`,
                        arrows: 'to'
                    })),
                    ...comment_edges.map(e => ({
                        from: e.source,
                        to: e.target,
                        value: e.weight,
                        color: { color: '#3498db', highlight: '#2980b9' },
                        title: `${e.weight} Comment${e.weight > 1 ? 's' : ''}`,
                        arrows: 'to'
                    }))
                ];

                // Stats anzeigen
                const stats = `<small style="position:absolute;top:5px;left:10px;background:rgba(255,255,255,0.9);padding:4px 8px;border-radius:4px;z-index:10">
                    ${nodes.length} Users | ${like_edges.length} Like-Verbindungen (rot) | ${comment_edges.length} Comment-Verbindungen (blau)
                </small>`;
                container.innerHTML = stats;

                const graphDiv = document.createElement('div');
                graphDiv.style.cssText = 'width:100%;height:100%';
                container.appendChild(graphDiv);

                // Vis.js Network
                new vis.Network(graphDiv, { nodes: visNodes, edges: visEdges }, {
                    nodes: {
                        font: { size: 12 },
                        scaling: { min: 20, max: 40 }
                    },
                    edges: {
                        smooth: { type: 'continuous' },
                        scaling: { min: 1, max: 8 }
                    },
                    physics: {
                        stabilization: { iterations: 50, fit: true },
                        barnesHut: { gravitationalConstant: -2000, springLength: 120 }
                    },
                    groups: {
                        admin: { color: { border: '#e74c3c', background: '#fadbd8' } },
                        moderator: { color: { border: '#f39c12', background: '#fef5e7' } },
                        member: { color: { border: '#3498db', background: '#ebf5fb' } }
                    }
                });
            }

            // filter
            const membersFilterExpandedKey = "members.filter_expanded";
            let filterExpanded = false;
            let updateFilterToggleButton = () => {
                if (filterExpanded) document.getElementById("hide-show-filter").innerText = "Hide Filter";
                else document.getElementById("hide-show-filter").innerText = "Show Filter";
            };
            let toggleFilterExpanded = () => {
                filterExpanded = !filterExpanded;
                ConfigEntry.set(membersFilterExpandedKey, filterExpanded.toString()).then();
                document.getElementById("filter").style.display = filterExpanded ? "block" : "none";
                updateFilterToggleButton();
            };

            // community selector/selection
            let changeCurrentCommunity = (community) => {
                ConfigEntry.set("current_community", community).then(() => {
                    window.location.reload();
                });
            };
            let getCurrentCommunity = async () => await ConfigEntry.get("current_community");
            let communityListData = [];
            let currentCommunity = "";

            // view selector
            const membersViewConfigKey = "members.current_view";
            let currentView = "list";
            let setCurrentView = (view) => {
                currentView = view;
                ConfigEntry.set(membersViewConfigKey, view).then();
                renderMembersView();
            };
            let getCurrentView = async () => {
                const view = await ConfigEntry.get(membersViewConfigKey);
                if (view) currentView = view;
            };

            //
            //
            // region MEMBERS
            //
            //

            // load members
            let members = [];

            let loadMembers = async () => {
                const res = await post('/api/user/filter', filterState);
                if (res.ok) {
                    members = res.data;
                    document.getElementById("memberAmount").innerText = members.length.toString();
                    renderMembersView();
                    renderSecondaryView();
                }
            };

            const formatDate = (ts) => ts ? new Date(ts * 1000).toLocaleDateString() : '-';

            const formatAge = (ts) => {
                if (!ts) return '-';
                const now = Math.floor(Date.now() / 1000);
                const diff = now - ts;
                if (diff < 60) return 'gerade eben';
                if (diff < 3600) return Math.floor(diff / 60) + ' Min';
                if (diff < 86400) return Math.floor(diff / 3600) + ' Std';
                return Math.floor(diff / 86400) + ' Tage';
            };

            const renderMemberCard = (member, showJson = false) => {
                return `
                    <article onclick="loadAndRenderProfileDetails(${member.id})" style="cursor: pointer">
                        <b>@${member.name}</b> - ${member.first_name} ${member.last_name}<br>
                        <small>
                            Role: <b>${member.member_role || '-'}</b> |
                            Points: <b>${member.points || 0}</b><br>
                            Last Active: ${formatDate(member.last_active)} |
                            Joined: ${formatDate(member.member_created_at)} |
                            <i>Fetched: ${formatAge(member.fetched_at)}</i>
                        </small>
                        ${showJson ? `<pre>${JSON.stringify(member, null, 2)}</pre>` : ''}
                    </article>
                `;
            };

            const renderMembersView = () => {
                const membersView = document.getElementById("members-view");
                membersView.innerHTML= "";
                const secondaryViewActions = document.getElementById("secondary-views");
                if (currentView === 'graph') secondaryViewActions.style.display = 'none';
                else secondaryViewActions.style.display = 'inline';
                switch(currentView){
                    case "list": {
                        membersView.innerHTML = `
                            <div style="flex-grow: 1; max-width: 50%" id="members-list" ></div>
                            <div style="flex-grow: 1; max-width: 50%" id='secondary-view'></div>
                        `;
                        const membersList = document.getElementById("members-list");
                        for (let member of members) {
                            membersList.insertAdjacentHTML("beforeend", renderMemberCard(member, false));
                        }
                    }break;
                    case "card": {
                        membersView.innerHTML = `
                            <div style="flex-grow: 1; max-width: 50%" id="members-list" ></div>
                            <div style="flex-grow: 1; max-width: 50%" id='secondary-view'></div>
                        `;
                        const membersList = document.getElementById("members-list");
                        for (let member of members) {
                            membersList.insertAdjacentHTML("beforeend", renderMemberCard(member, true));
                        }
                    }break;
                    case "graph": {
                        membersView.innerHTML = `<div id="graph-container" style="width: 100%; height: 600px; border: 1px solid #ccc; position: relative;"></div>`;
                        const container = document.getElementById("graph-container");
                        loadAndRenderInteractionGraph(container, members);
                    } break;
                    default:
                        membersView.innerHTML= "UNKNOWN VIEW -> this is a bug";
                        break;
                }
            }

            //
            //
            // region PROFILE DETAILS
            //
            //

            // render profile details
            let loadAndRenderProfileDetails = (memberId) => {
                (async ()=>{
                    const secondaryView = document.getElementById("secondary-view");
                    secondaryView.innerHTML = `<h3>Loading...</h3>`;
                    const user = await User.get(memberId);

                    // Fetch posts, communities, and liked posts in parallel
                    const [postsRes, communitiesRes, profileCommunitiesRes, likedPostsRes] = await Promise.all([
                        get(`/api/user/${memberId}/posts`),
                        get(`/api/user/${memberId}/communities`),
                        get(`/api/user/${memberId}/profile-communities`),
                        get(`/api/user/${memberId}/liked-posts`)
                    ]);
                    const posts = postsRes.ok ? postsRes.data : [];
                    const communities = communitiesRes.ok ? communitiesRes.data : [];
                    const profileCommunities = profileCommunitiesRes.ok ? profileCommunitiesRes.data : [];
                    const likedPosts = likedPostsRes.ok ? likedPostsRes.data : [];

                    // Render user info
                    let html = `<h3>Profile Details for @${user.name}</h3>`;
                    html += `<small>${user.first_name} ${user.last_name} | Role: ${user.member_role || '-'} | Points: ${user.points || 0}</small>`;

                    // Render communities from profile (more complete)
                    html += `<h4>COMMUNITIES (${profileCommunities.length || communities.length})</h4>`;
                    if (profileCommunities.length) {
                        html += `<div>`;
                        for (const c of profileCommunities) {
                            html += `<small style="margin-right: 8px; margin-bottom: 4px; padding: 2px 6px; background: #eee; border-radius: 4px; display: inline-block; cursor: pointer"
                                onclick="changeCurrentCommunity('${c.slug}')">${c.name}</small>`;
                        }
                        html += `</div>`;
                    } else if (communities.length) {
                        // Fallback to user table communities
                        html += `<div>`;
                        for (const slug of communities) {
                            html += `<small style="margin-right: 8px; padding: 2px 6px; background: #eee; border-radius: 4px; cursor: pointer"
                                onclick="changeCurrentCommunity('${slug}')">${slug}</small>`;
                        }
                        html += `</div>`;
                    } else {
                        html += `<small>No communities found (profile not fetched yet)</small>`;
                    }

                    // Render posts
                    html += `<h4>POSTS (${posts.length})</h4>`;
                    if (posts.length) {
                        for (const post of posts) {
                            const meta = post.metadata ? JSON.parse(post.metadata) : {};
                            const title = meta.title || post.name || '(Untitled)';
                            html += `<article style="margin: 4px 0; padding: 8px; border-left: 3px solid #3498db">
                                <b>${title}</b><br>
                                <small>
                                    ${post.upvotes || 0} upvotes | ${post.comments || 0} comments |
                                    ${post.community_slug}
                                </small>
                            </article>`;
                        }
                    } else {
                        html += `<small>No posts found</small>`;
                    }

                    // Render liked posts
                    html += `<h4>LIKED POSTS (${likedPosts.length})</h4>`;
                    if (likedPosts.length) {
                        for (const post of likedPosts) {
                            const meta = post.metadata ? JSON.parse(post.metadata) : {};
                            const title = meta.title || post.name || '(Untitled)';
                            html += `<article style="margin: 4px 0; padding: 8px; border-left: 3px solid #e74c3c">
                                <b>${title}</b><br>
                                <small>
                                    by <b>${post.user_name || '-'}</b> |
                                    ${post.upvotes || 0} upvotes | ${post.comments || 0} comments |
                                    ${post.community_slug}
                                </small>
                            </article>`;
                        }
                    } else {
                        html += `<small>No liked posts found (likes not fetched yet)</small>`;
                    }

                    html += `<h4>NOTES</h4><small>Coming soon...</small>`;
                    html += `<details><summary>Raw JSON</summary><pre>${JSON.stringify(user, null, 2)}</pre></details>`;

                    secondaryView.innerHTML = html;
                })();
            };

            //
            //
            // region 2. VIEW
            //
            //

            // secondary view selector
            const secondaryViewConfigKey = "members.secondary_view";
            let currentSecondaryView = "posts";
            let renderSecondaryView = () => {
                const secondaryView = document.getElementById('secondary-view');
                if (!secondaryView) return; // No secondary view in graph mode
                switch(currentSecondaryView){
                    case "posts": {
                        (async()=>{
                            secondaryView.innerHTML = `<h3>Loading Posts...</h3>`;
                            // Get skool_ids of currently filtered members
                            const skoolIds = members.map(m => m.skool_id);
                            const res = await post('/api/post/by-users', { skool_ids: skoolIds });
                            const data = res.ok ? res.data : [];
                            let html = `<h3>Posts (${data.length})</h3>`;
                            for (const p of data) {
                                const meta = p.metadata ? JSON.parse(p.metadata) : {};
                                const title = meta.title || p.name || '(Untitled)';
                                const content = meta.content || '';
                                const preview = content.length > 100 ? content.substring(0, 100) + '...' : content;
                                const createdAt = p.skool_created_at ? new Date(p.skool_created_at).toLocaleDateString() : '-';
                                html += `
                                    <article style="margin: 4px 0; padding: 8px; border-left: 3px solid #3498db">
                                        <b>${title}</b><br>
                                        <small style="color: #666">${preview}</small><br>
                                        <small>
                                            by <b>${p.user_name || '-'}</b> |
                                            ${p.upvotes || 0} upvotes | ${p.comments || 0} comments |
                                            ${p.community_slug} | ${createdAt}
                                        </small>
                                    </article>
                                `;
                            }
                            secondaryView.innerHTML = html;
                        })();
                    } break;
                    case "communities": {
                        (async()=>{
                            secondaryView.innerHTML = `<h3>Loading Communities...</h3>`;
                            // Get skool_ids of currently filtered members
                            const skoolIds = members.map(m => m.skool_id);
                            const res = await post('/api/communities/by-users', { skool_ids: skoolIds });
                            if (!res.ok) {
                                secondaryView.innerHTML = `<h3>Error loading communities</h3>`;
                                return;
                            }
                            let html = `<h3>Other Communities (${res.data.length})</h3>`;
                            html += `<small>Other communities of ${members.length} selected members</small><br><br>`;
                            for (const c of res.data) {
                                const name = c.name || c.slug;
                                const fetched = c.about_fetched ? '(details fetched)' : '';
                                html += `<article style="margin: 4px 0; padding: 8px; border-left: 3px solid #27ae60; cursor: pointer"
                                    onclick="changeCurrentCommunity('${c.slug}')">
                                    <b>${name}</b> <small style="color: #888">${fetched}</small><br>
                                    <small><b>${c.selection_count}</b> of selection | ${c.shared_user_count} global | slug: ${c.slug}</small>
                                </article>`;
                            }
                            if (!res.data.length) html += `<small>No other communities found for selected members.</small>`;
                            secondaryView.innerHTML = html;
                        })();
                    } break;
                    case "export": {
                        secondaryView.innerHTML = `
                            <h3>Export (${members.length} Members)</h3>
                            <p><small>Exportiert die aktuelle Selektion als CSV-Datei.</small></p>
                            <button onclick="downloadMembersCsv()">Download CSV</button>
                        `;
                    } break;
                    case "activity": {
                        (async()=>{
                            secondaryView.innerHTML = `<h3>Loading Activity...</h3>`;
                            const skoolIds = members.map(m => m.skool_id);

                            // Beide APIs parallel laden
                            const [communityRes, membersRes] = await Promise.all([
                                get('/api/activity/community?days=90'),
                                post('/api/activity/members', { skool_ids: skoolIds })
                            ]);

                            // Heatmap render function
                            const renderHeatmap = (matrix, weekdays) => {
                                const maxVal = Math.max(...matrix.flat(), 1);
                                const hourLabels = ['12AM','','','3AM','','','6AM','','','9AM','','','12PM','','','3PM','','','6PM','','','9PM','','',''];
                                let html = '<div style="display:grid; grid-template-columns: 40px repeat(7, 1fr); gap:1px; font-size:10px">';
                                html += '<div></div>';
                                for (const day of weekdays) html += `<div style="text-align:center">${day}</div>`;
                                for (let h = 0; h < 24; h++) {
                                    html += `<div style="text-align:right; padding-right:3px">${hourLabels[h]}</div>`;
                                    for (let d = 0; d < 7; d++) {
                                        const val = matrix[d][h];
                                        const intensity = val / maxVal;
                                        const alpha = 0.1 + intensity * 0.9;
                                        const bg = `rgba(147, 51, 234, ${alpha.toFixed(2)})`;
                                        html += `<div style="background:${bg}; height:10px; border-radius:1px" title="${weekdays[d]} ${h}:00 - ${val}"></div>`;
                                    }
                                }
                                html += '</div>';
                                return html;
                            };

                            let html = `<h3>Activity (${members.length} members)</h3>`;

                            // Heatmap oben
                            if (membersRes.ok) {
                                const md = membersRes.data;
                                html += `<small>Wann sind Members aktiv? (Wochentag x Stunde)</small>`;
                                html += renderHeatmap(md.activity_matrix, md.weekdays);
                            }

                            // Line Chart unten (3 Monate)
                            if (communityRes.ok) {
                                const cd = communityRes.data;
                                html += `
                                    <h4 style="margin-top:20px">Last 3 Months</h4>
                                    <canvas id="activity-chart" style="max-height: 200px"></canvas>
                                    <small>Total: ${cd.posts.reduce((a,b)=>a+b,0)} posts, ${cd.comments.reduce((a,b)=>a+b,0)} comments</small>
                                `;
                            }

                            secondaryView.innerHTML = html;

                            // Chart.js nach DOM-Update
                            if (communityRes.ok) {
                                const cd = communityRes.data;
                                new Chart(document.getElementById('activity-chart').getContext('2d'), {
                                    type: 'line',
                                    data: {
                                        labels: cd.days.map(d => d.slice(5)),
                                        datasets: [
                                            { label: 'Posts', data: cd.posts, borderColor: '#3498db', tension: 0.3, pointRadius: 0 },
                                            { label: 'Comments', data: cd.comments, borderColor: '#e74c3c', tension: 0.3, pointRadius: 0 }
                                        ]
                                    },
                                    options: { responsive: true, maintainAspectRatio: true }
                                });
                            }
                        })();
                    } break;
                    default: // posible -> not a bug
                        secondaryView.innerText = "";
                        break;
                }
            };
            let setCurrentSecondaryView = (view) => {
                currentSecondaryView = view;
                ConfigEntry.set(secondaryViewConfigKey, view).then();
                renderSecondaryView();
            };
            let getCurrentSecondaryView = async () => {
                const view = await ConfigEntry.get(secondaryViewConfigKey);
                if (view) currentSecondaryView = view;
            }

            //
            //
            // region ONLOAD
            //
            //

            // onload
            window.onload = () => {
                console.log("HELLO");
                document.body.addEventListener("click", ()=>{
                    console.log("BODY CLICKED");
                });

                // load members
                (async () => {

                    // members view selector
                    await getCurrentView();
                    const select = document.getElementById("membersViewSelection");
                    select.value = currentView;
                    select.onchange = () => setCurrentView(select.value);

                    // load members with filter
                    await loadMembers();

                    // secondary view selector
                    await getCurrentSecondaryView();
                    renderSecondaryView();

                })().then();

                //filter
                ConfigEntry.get(membersFilterExpandedKey).then((value) => {
                    filterExpanded = value === "true";
                    console.log("Filter expanded loaded as: " + filterExpanded, value);
                    document.getElementById("filter").style.display = filterExpanded ? "block" : "none";
                    updateFilterToggleButton();
                });

                lib.setupThemeOnLoad().then();

                // community list
                (async () => {
                    currentCommunity = await getCurrentCommunity();
                    communityListData = await lib.loadAllCommunities();
                    const currentCommunitySelectorHeader = document.getElementById("currentCommunitySelectorHeader");
                    for (let community of communityListData) {
                        const option = document.createElement("option");
                        if (community === currentCommunity) option.selected = true;
                        option.value = community;
                        option.innerText = community;
                        currentCommunitySelectorHeader.appendChild(option);
                    }
                })().then();
            }

            //
            //
            // region FILTER STATE
            //
            //

            // todo: load filter state from current filter, sicne once can have multiple filters
            let filterState = {
                sortBy: 'name_asc',
                searchTerm: '',
                include: {},
                exclude: {}
            }

            let setSort = (value) => {
                filterState.sortBy = value;
                loadMembers();
            }

            let renderFilterConditions = () => {
                const renderBadges = (mode) => {
                    let html = '';
                    const state = filterState[mode] || {};
                    for (let key in state) {
                        const val = state[key];
                        let label = '';
                        switch (key) {
                            case 'member_role':
                                label = `Role: ${val}`;
                                break;
                            case 'active_since':
                                label = `Active in last ${val} days`;
                                break;
                            case 'inactive_since':
                                label = `Inactive since ${val} days`;
                                break;
                            case 'joined_since':
                                label = `Joined in last ${val} days`;
                                break;
                            case 'joined_before':
                                label = `Joined before ${val} days`;
                                break;
                            case 'points_min':
                                label = `Points >= ${val}`;
                                break;
                            case 'points_max':
                                label = `Points <= ${val}`;
                                break;
                            case 'is_former_member':
                                label = `Former member`;
                                break;
                            default:
                                continue;
                        }
                        html += `<small class='filter-badge'>${label} <b style="cursor: pointer" onclick="setFilterCondition('${mode}', '${key}', -1)">X</b></small> `;
                    }
                    return html;
                };
                document.getElementById('filter-conditions-include').innerHTML = renderBadges('include');
                document.getElementById('filter-conditions-exclude').innerHTML = renderBadges('exclude');
            };

            let addActiveSinceFilterCondition = () => {

            }

            let setFilterCondition = (mode, key, value) => {
                if (mode !== 'include' && mode !== 'exclude'){
                    console.error('Unknown filter condition mode: ' + mode);
                    return;
                }
                if(value === "-1" || value === "false" || value === false || value === null || value === undefined || value === -1){
                    delete filterState[mode][key];
                }
                else{
                    filterState[mode][key] = value;
                }
                renderFilterConditions();
                loadMembers();
            };

            let openFilterDialog = (mode) => {
                document.querySelectorAll('dialog').forEach(d => d.remove());
                let dialogHtml;
                const state = filterState[mode] || {};
                const daysOptions = `
                    <option value="-1">-</option>
                    <option value="5">5 days</option>
                    <option value="20">20 days</option>
                    <option value="30">30 days</option>
                    <option value="90">3 months</option>
                    <option value="180">6 months</option>
                    <option value="365">1 year</option>
                `;
                if (mode === 'include' || mode === 'exclude'){
                    dialogHtml = `
                        <dialog>
                            <h4>${mode === 'include' ? 'Include' : 'Exclude'} Members</h4>
                            <table>
                                <tr>
                                    <td><label>Role:</label></td>
                                    <td><select onchange="setFilterCondition('${mode}','member_role', this.value)">
                                        <option value="-1">Any</option>
                                        <option value="admin" ${state.member_role==='admin'?'selected':''}>Admin</option>
                                        <option value="moderator" ${state.member_role==='moderator'?'selected':''}>Moderator</option>
                                        <option value="member" ${state.member_role==='member'?'selected':''}>Member</option>
                                    </select></td>
                                </tr>
                                <tr>
                                    <td><label>Active in last:</label></td>
                                    <td><select onchange="setFilterCondition('${mode}','active_since', this.value)">
                                        ${daysOptions.replace(`value="${state.active_since||'-1'}"`, `value="${state.active_since||'-1'}" selected`)}
                                    </select></td>
                                </tr>
                                <tr>
                                    <td><label>Inactive since:</label></td>
                                    <td><select onchange="setFilterCondition('${mode}','inactive_since', this.value)">
                                        ${daysOptions.replace(`value="${state.inactive_since||'-1'}"`, `value="${state.inactive_since||'-1'}" selected`)}
                                    </select></td>
                                </tr>
                                <tr>
                                    <td><label>Joined since:</label></td>
                                    <td><select onchange="setFilterCondition('${mode}','joined_since', this.value)">
                                        ${daysOptions.replace(`value="${state.joined_since||'-1'}"`, `value="${state.joined_since||'-1'}" selected`)}
                                    </select></td>
                                </tr>
                                <tr>
                                    <td><label>Joined before:</label></td>
                                    <td><select onchange="setFilterCondition('${mode}','joined_before', this.value)">
                                        ${daysOptions.replace(`value="${state.joined_before||'-1'}"`, `value="${state.joined_before||'-1'}" selected`)}
                                    </select></td>
                                </tr>
                                <tr>
                                    <td><label>Min Points:</label></td>
                                    <td><input type="number" min="0" value="${state.points_min||''}" placeholder="0"
                                        onchange="setFilterCondition('${mode}','points_min', this.value || -1)"></td>
                                </tr>
                                <tr>
                                    <td><label>Max Points:</label></td>
                                    <td><input type="number" min="0" value="${state.points_max||''}" placeholder="∞"
                                        onchange="setFilterCondition('${mode}','points_max', this.value || -1)"></td>
                                </tr>
                                <tr>
                                    <td><label>Former Member:</label></td>
                                    <td><input type="checkbox" ${state.is_former_member ? 'checked' : ''}
                                        onchange="setFilterCondition('${mode}','is_former_member', this.checked ? 'true' : -1)">
                                        <small>Left the community</small></td>
                                </tr>
                            </table>
                            <br>
                            <button onclick="this.closest('dialog').close()">Close</button>
                        </dialog>
                    `;
                }
                else { console.error('Unknown filter dialog mode: ' + mode); return;}
                document.body.insertAdjacentHTML('beforeend', dialogHtml);
                setTimeout(() => {
                    const dialog = document.querySelector('dialog');
                    dialog.showModal();
                }, 100);
            }

            //
            //
            // region EXPORT
            //
            //

            let downloadMembersCsv = async () => {
                const res = await fetch('/api/user/export-csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filterState)
                });
                if (!res.ok) { alert('Export failed'); return; }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'members.csv';
                a.click();
                URL.revokeObjectURL(url);
            };

            //
            //
            // region HTML
            //
            //

        </script>
    </head>
    <body>

        <header style="height: 30px">

            <select id="viewSelection" onchange="window.location.href=this.value">
                <option value="/members.html" selected> MEMBERS </option>
                <option value="/posts.html"> POSTS </option>
                <option value="/communities.html"> COMMUNITIES </option>
                <option value="/chats.html" > CHATS </option>
                <option value="/prompts.html"> PROMPTS </option>
                <option value="/data.html"> DATABASE </option>
            </select>
            |
            Total: <b id="memberAmount">---</b>
            |
            <button id="hide-show-filter" onclick="toggleFilterExpanded()"> </button>
            |
            <select id="membersViewSelection">
                <option value="list">LIST VIEW</option>
                <option value="card">CARD VIEW</option>
                <option value="graph">GRAPH VIEW</option>
            </select>
            |
            <!-- Secondary view are applied to the right, but only if the main view is
            list or card view -> since on graph view there is no space for that
            This is used to display all posts of the selected users or their communities etc.
             -->
            <span id="secondary-views">
                <small>Actions:</small>
                <button onclick="setCurrentSecondaryView('posts')">Posts</button>
                <button onclick="setCurrentSecondaryView('communities')">Communities</button>
                <button onclick="setCurrentSecondaryView('activity')">Activity</button>
                <button onclick="setCurrentSecondaryView('export')">Export</button>
            </span>
            <nav style="float: right">

                <select id="currentCommunitySelectorHeader" onchange="changeCurrentCommunity(this.value)"></select>

                <button onclick="window.location.href='/settings.html'"> Settings </button>
                <select id="themeSelection" onchange="lib.setTheme(this.value).then()">
                    <option value="blue"> Blue </option>
                    <option value="red"> Red </option>
                </select>
            </nav>

        </header>

        <article id="filter" style="display:none">
            <div style="margin-bottom: 5px">
                <input id="search-input" placeholder="Search for members..." onchange="filterState.searchTerm = this.value; loadMembers()">
                <select id="sort-select" onchange="setSort(this.value)">
                    <option value="name_asc">Name A-Z</option>
                    <option value="name_desc">Name Z-A</option>
                    <option value="points_desc">Points (high)</option>
                    <option value="points_asc">Points (low)</option>
                    <option value="last_active_desc">Last active (recent)</option>
                    <option value="last_active_asc">Last active (oldest)</option>
                    <option value="joined_desc">Joined (newest)</option>
                    <option value="joined_asc">Joined (oldest)</option>
                </select>
            </div>
            <div style="margin-bottom: 5px">
                Include: <button onclick="openFilterDialog('include')">+</button>
                <span id="filter-conditions-include"></span>
            </div>
            <div>
                Exclude: <button onclick="openFilterDialog('exclude')">+</button>
                <span id="filter-conditions-exclude"></span>
            </div>

        </article>

        <main style=" display: flex; flex-wrap: wrap; width: 100%;" id="members-view">
            <!-- MEMBERS VIEW RENDERED HERE -->
        </main>
    </body>
</html>