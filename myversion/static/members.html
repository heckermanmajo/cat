<!DOCTYPE html>
<html lang="en">
    <head>
        <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
        <script src="entity.js"></script>
        <script src="/entities/config_entry.js"></script>
        <script src="/entities/user.js"></script>
        <script src="/entities/post.js"></script>
        <script src="/lib.js"></script>
        <link href="/default.css" type="text/css" rel="stylesheet">
        <title>Cat</title>
        <script>

            // =========================================================================
            // Graph Rendering (Vis.js)
            // =========================================================================
            /**
             * Rendert einen Member-Netzwerk-Graph.
             * @param {HTMLElement} container - DOM Element für den Graph
             * @param {Array} nodes - [{id, name, role, posts}, ...]
             * @param {Array} edges - [{from, to, weight}, ...]
             */
            function renderMemberGraph(container, nodes, edges) {
                const visNodes = nodes.map(n => ({
                    id: n.id,
                    label: n.name,
                    title: `${n.name}\nRole: ${n.role}\nPosts: ${n.posts}`,
                    value: n.posts || 1,
                    group: n.role
                }));
                const visEdges = edges.map(e => ({
                    from: e.from,
                    to: e.to,
                    value: e.weight || 1
                }));
                const data = { nodes: visNodes, edges: visEdges };
                const options = {
                    nodes: {
                        shape: 'dot',
                        scaling: { min: 10, max: 30 }
                    },
                    edges: {
                        smooth: false,
                        scaling: { min: 1, max: 5 }
                    },
                    physics: {
                        stabilization: { iterations: 100 }
                    },
                    groups: {
                        admin: { color: '#e74c3c' },
                        moderator: { color: '#f39c12' },
                        member: { color: '#3498db' }
                    }
                };
                new vis.Network(container, data, options);
            }

            // Dummy-Daten für Test
            const dummyNodes = [
                {id: "1", name: "Max Admin", role: "admin", posts: 50},
                {id: "2", name: "Anna Mod", role: "moderator", posts: 35},
                {id: "3", name: "Tom Member", role: "member", posts: 20},
                {id: "4", name: "Lisa Member", role: "member", posts: 15},
                {id: "5", name: "Ben Member", role: "member", posts: 8},
                {id: "6", name: "Sara Member", role: "member", posts: 5},
            ];
            const dummyEdges = [
                {from: "1", to: "2", weight: 10},
                {from: "1", to: "3", weight: 5},
                {from: "2", to: "3", weight: 8},
                {from: "2", to: "4", weight: 3},
                {from: "3", to: "5", weight: 4},
                {from: "4", to: "6", weight: 2},
                {from: "1", to: "5", weight: 6},
            ];

            // filter
            const membersFilterExpandedKey = "members.filter_expanded";
            let filterExpanded = false;
            let updateFilterToggleButton = () => {
                if (filterExpanded) document.getElementById("hide-show-filter").innerText = "Hide Filter";
                else document.getElementById("hide-show-filter").innerText = "Show Filter";
            };
            let toggleFilterExpanded = () => {
                filterExpanded = !filterExpanded;
                ConfigEntry.set(membersFilterExpandedKey, filterExpanded.toString()).then();
                document.getElementById("filter").style.display = filterExpanded ? "block" : "none";
                updateFilterToggleButton();
            };

            // community selector/selection
            let changeCurrentCommunity = (community) => {
                ConfigEntry.set("current_community", community).then(() => {
                    window.location.reload();
                });
            };
            let getCurrentCommunity = async () => await ConfigEntry.get("current_community");
            let communityListData = [];
            let currentCommunity = "";

            // view selector
            const membersViewConfigKey = "members.current_view";
            let currentView = "list";
            let setCurrentView = (view) => {
                currentView = view;
                ConfigEntry.set(membersViewConfigKey, view).then();
                renderMembersView();
            };
            let getCurrentView = async () => {
                const view = await ConfigEntry.get(membersViewConfigKey);
                if (view) currentView = view;
            };

            //
            //
            // region MEMBERS
            //
            //

            // load members
            let members = [];

            let loadMembers = async () => {
                const res = await post('/api/user/filter', filterState);
                if (res.ok) {
                    members = res.data;
                    document.getElementById("memberAmount").innerText = members.length.toString();
                    renderMembersView();
                }
            };

            const formatDate = (ts) => ts ? new Date(ts * 1000).toLocaleDateString() : '-';

            const formatAge = (ts) => {
                if (!ts) return '-';
                const now = Math.floor(Date.now() / 1000);
                const diff = now - ts;
                if (diff < 60) return 'gerade eben';
                if (diff < 3600) return Math.floor(diff / 60) + ' Min';
                if (diff < 86400) return Math.floor(diff / 3600) + ' Std';
                return Math.floor(diff / 86400) + ' Tage';
            };

            const renderMemberCard = (member, showJson = false) => {
                return `
                    <article onclick="loadAndRenderProfileDetails(${member.id})" style="cursor: pointer">
                        <b>@${member.name}</b> - ${member.first_name} ${member.last_name}<br>
                        <small>
                            Role: <b>${member.member_role || '-'}</b> |
                            Points: <b>${member.points || 0}</b><br>
                            Last Active: ${formatDate(member.last_active)} |
                            Joined: ${formatDate(member.member_created_at)} |
                            <i>Fetched: ${formatAge(member.fetched_at)}</i>
                        </small>
                        ${showJson ? `<pre>${JSON.stringify(member, null, 2)}</pre>` : ''}
                    </article>
                `;
            };

            const renderMembersView = () => {
                const membersView = document.getElementById("members-view");
                membersView.innerHTML= "";
                const secondaryViewActions = document.getElementById("secondary-views");
                if (currentView === 'graph') secondaryViewActions.style.display = 'none';
                else secondaryViewActions.style.display = 'inline';
                switch(currentView){
                    case "list": {
                        membersView.innerHTML = `
                            <div style="flex-grow: 1; max-width: 50%" id="members-list" ></div>
                            <div style="flex-grow: 1; max-width: 50%" id='secondary-view'></div>
                        `;
                        const membersList = document.getElementById("members-list");
                        for (let member of members) {
                            membersList.insertAdjacentHTML("beforeend", renderMemberCard(member, false));
                        }
                    }break;
                    case "card": {
                        membersView.innerHTML = `
                            <div style="flex-grow: 1; max-width: 50%" id="members-list" ></div>
                            <div style="flex-grow: 1; max-width: 50%" id='secondary-view'></div>
                        `;
                        const membersList = document.getElementById("members-list");
                        for (let member of members) {
                            membersList.insertAdjacentHTML("beforeend", renderMemberCard(member, true));
                        }
                    }break;
                    case "graph": {
                        membersView.innerHTML = `<div id="graph-container" style="width: 100%; height: 600px; border: 1px solid #ccc;"></div>`;
                        const container = document.getElementById("graph-container");
                        renderMemberGraph(container, dummyNodes, dummyEdges);
                    } break;
                    default:
                        membersView.innerHTML= "UNKNOWN VIEW -> this is a bug";
                        break;
                }
            }

            //
            //
            // region PROFILE DETAILS
            //
            //

            // render profile details
            let loadAndRenderProfileDetails = (memberId) => {
                (async ()=>{
                    const secondaryView = document.getElementById("secondary-view");
                    secondaryView.innerHTML = `<h3>Loading...</h3>`;
                    const user = await User.get(memberId);

                    // Fetch posts and communities in parallel
                    const [postsRes, communitiesRes] = await Promise.all([
                        get(`/api/user/${memberId}/posts`),
                        get(`/api/user/${memberId}/communities`)
                    ]);
                    const posts = postsRes.ok ? postsRes.data : [];
                    const communities = communitiesRes.ok ? communitiesRes.data : [];

                    // Render user info
                    let html = `<h3>Profile Details for @${user.name}</h3>`;
                    html += `<small>${user.first_name} ${user.last_name} | Role: ${user.member_role || '-'} | Points: ${user.points || 0}</small>`;

                    // Render communities
                    html += `<h4>COMMUNITIES (${communities.length})</h4>`;
                    if (communities.length) {
                        html += `<div>`;
                        for (const slug of communities) {
                            html += `<small style="margin-right: 8px; padding: 2px 6px; background: #eee; border-radius: 4px">${slug}</small>`;
                        }
                        html += `</div>`;
                    } else {
                        html += `<small>No communities found</small>`;
                    }

                    // Render posts
                    html += `<h4>POSTS (${posts.length})</h4>`;
                    if (posts.length) {
                        for (const post of posts) {
                            const meta = post.metadata ? JSON.parse(post.metadata) : {};
                            const title = meta.title || post.name || '(Untitled)';
                            html += `<article style="margin: 4px 0; padding: 8px; border-left: 3px solid #3498db">
                                <b>${title}</b><br>
                                <small>
                                    ${post.upvotes || 0} upvotes | ${post.comments || 0} comments |
                                    ${post.community_slug}
                                </small>
                            </article>`;
                        }
                    } else {
                        html += `<small>No posts found</small>`;
                    }

                    html += `<h4>NOTES</h4><small>Coming soon...</small>`;
                    html += `<h4>Liked POSTS</h4><small>Coming soon...</small>`;
                    html += `<details><summary>Raw JSON</summary><pre>${JSON.stringify(user, null, 2)}</pre></details>`;

                    secondaryView.innerHTML = html;
                })();
            };

            //
            //
            // region 2. VIEW
            //
            //

            // secondary view selector
            const secondaryViewConfigKey = "members.secondary_view";
            let currentSecondaryView = "posts";
            let renderSecondaryView = () => {
                switch(currentSecondaryView){
                    case "posts": {
                        (async()=>{
                            document.getElementById('secondary-view').innerHTML = `<h3>Loading Posts...</h3>`;
                            /** @type {Post[]} */
                            let data = await Post.all();
                            let html = `<h3>Posts (${data.length})</h3>`;
                            for (const post of data) {
                                const meta = post.metadata ? JSON.parse(post.metadata) : {};
                                const title = meta.title || post.name || '(Untitled)';
                                const content = meta.content || '';
                                const preview = content.length > 100 ? content.substring(0, 100) + '...' : content;
                                const createdAt = post.skool_created_at ? new Date(post.skool_created_at).toLocaleDateString() : '-';
                                html += `
                                    <article style="margin: 4px 0; padding: 8px; border-left: 3px solid #3498db">
                                        <b>${title}</b><br>
                                        <small style="color: #666">${preview}</small><br>
                                        <small>
                                            by <b>${post.user_name || '-'}</b> |
                                            ${post.upvotes || 0} upvotes | ${post.comments || 0} comments |
                                            ${post.community_slug} | ${createdAt}
                                        </small>
                                    </article>
                                `;
                            }
                            document.getElementById('secondary-view').innerHTML = html;
                        })();
                    } break;
                    case "communities": {
                        (async()=>{
                            const view = document.getElementById('secondary-view');
                            view.innerHTML = `<h3>Loading Communities...</h3>`;
                            const res = await get('/api/other-communities');
                            if (!res.ok) {
                                view.innerHTML = `<h3>Error loading communities</h3>`;
                                return;
                            }
                            let html = `<h3>Other Communities (${res.data.length})</h3>`;
                            html += `<small>Discovered from profile fetches</small><br><br>`;
                            for (const c of res.data) {
                                const name = c.name || c.slug;
                                const fetched = c.about_fetched ? '(details fetched)' : '';
                                html += `<article style="margin: 4px 0; padding: 8px; border-left: 3px solid #27ae60; cursor: pointer"
                                    onclick="changeCurrentCommunity('${c.slug}')">
                                    <b>${name}</b> <small style="color: #888">${fetched}</small><br>
                                    <small>${c.shared_user_count} shared members | slug: ${c.slug}</small>
                                </article>`;
                            }
                            if (!res.data.length) html += `<small>No other communities found yet. Fetch some profiles first.</small>`;
                            view.innerHTML = html;
                        })();
                    } break;
                    case "export": {
                        document.getElementById('secondary-view').innerText = "EXPORT";
                    } break;
                    case "activity": {
                        document.getElementById('secondary-view').innerText = "ACTIVITY";
                    } break;
                    default: // posible -> not a bug
                        document.getElementById('secondary-view').innerText = "";
                        break;
                }
            };
            let setCurrentSecondaryView = (view) => {
                currentSecondaryView = view;
                ConfigEntry.set(secondaryViewConfigKey, view).then();
                renderSecondaryView();
            };
            let getCurrentSecondaryView = async () => {
                const view = await ConfigEntry.get(secondaryViewConfigKey);
                if (view) currentSecondaryView = view;
            }

            //
            //
            // region ONLOAD
            //
            //

            // onload
            window.onload = async () => {

                // load members
                (async () => {

                    // members view selector
                    await getCurrentView();
                    const select = document.getElementById("membersViewSelection");
                    select.value = currentView;
                    select.onchange = () => setCurrentView(select.value);

                    // load members with filter
                    await loadMembers();

                    // secondary view selector
                    await getCurrentSecondaryView();
                    renderSecondaryView();

                })().then();

                //filter
                ConfigEntry.get(membersFilterExpandedKey).then((value) => {
                    filterExpanded = value === "true";
                    console.log("Filter expanded loaded as: " + filterExpanded, value);
                    document.getElementById("filter").style.display = filterExpanded ? "block" : "none";
                    updateFilterToggleButton();
                });

                lib.setupThemeOnLoad().then();

                // community list
                {
                    currentCommunity = await getCurrentCommunity();
                    communityListData = await lib.loadAllCommunities();
                    const currentCommunitySelectorHeader = document.getElementById("currentCommunitySelectorHeader");
                    for (let community of communityListData) {
                        const option = document.createElement("option");
                        if (community === currentCommunity) option.selected = true;
                        option.value = community;
                        option.innerText = community;
                        currentCommunitySelectorHeader.appendChild(option);
                    }
                }
            }

            //
            //
            // region FILTER STATE
            //
            //

            // todo: load filter state from current filter, sicne once can have multiple filters
            let filterState = {
                sortBy: 'name_asc',
                searchTerm: '',
                include: {},
                exclude: {}
            }

            let setSort = (value) => {
                filterState.sortBy = value;
                loadMembers();
            }

            let renderFilterConditions = () => {
                const renderBadges = (mode) => {
                    let html = '';
                    const state = filterState[mode] || {};
                    for (let key in state) {
                        const val = state[key];
                        let label = '';
                        switch (key) {
                            case 'member_role':
                                label = `Role: ${val}`;
                                break;
                            case 'active_since':
                                label = `Active in last ${val} days`;
                                break;
                            case 'inactive_since':
                                label = `Inactive since ${val} days`;
                                break;
                            case 'joined_since':
                                label = `Joined in last ${val} days`;
                                break;
                            case 'joined_before':
                                label = `Joined before ${val} days`;
                                break;
                            case 'points_min':
                                label = `Points >= ${val}`;
                                break;
                            case 'points_max':
                                label = `Points <= ${val}`;
                                break;
                            default:
                                continue;
                        }
                        html += `<small class='filter-badge'>${label} <b style="cursor: pointer" onclick="setFilterCondition('${mode}', '${key}', -1)">X</b></small> `;
                    }
                    return html;
                };
                document.getElementById('filter-conditions-include').innerHTML = renderBadges('include');
                document.getElementById('filter-conditions-exclude').innerHTML = renderBadges('exclude');
            };

            let addActiveSinceFilterCondition = () => {

            }

            let setFilterCondition = (mode, key, value) => {
                if (mode !== 'include' && mode !== 'exclude'){
                    console.error('Unknown filter condition mode: ' + mode);
                    return;
                }
                if(value === "-1" || value === "false" || value === false || value === null || value === undefined || value === -1){
                    delete filterState[mode][key];
                }
                else{
                    filterState[mode][key] = value;
                }
                renderFilterConditions();
                loadMembers();
            };

            let openFilterDialog = (mode) => {
                document.querySelectorAll('dialog').forEach(d => d.remove());
                let dialogHtml;
                const state = filterState[mode] || {};
                const daysOptions = `
                    <option value="-1">-</option>
                    <option value="5">5 days</option>
                    <option value="20">20 days</option>
                    <option value="30">30 days</option>
                    <option value="90">3 months</option>
                    <option value="180">6 months</option>
                    <option value="365">1 year</option>
                `;
                if (mode === 'include' || mode === 'exclude'){
                    dialogHtml = `
                        <dialog>
                            <h4>${mode === 'include' ? 'Include' : 'Exclude'} Members</h4>
                            <table>
                                <tr>
                                    <td><label>Role:</label></td>
                                    <td><select onchange="setFilterCondition('${mode}','member_role', this.value)">
                                        <option value="-1">Any</option>
                                        <option value="admin" ${state.member_role==='admin'?'selected':''}>Admin</option>
                                        <option value="moderator" ${state.member_role==='moderator'?'selected':''}>Moderator</option>
                                        <option value="member" ${state.member_role==='member'?'selected':''}>Member</option>
                                    </select></td>
                                </tr>
                                <tr>
                                    <td><label>Active in last:</label></td>
                                    <td><select onchange="setFilterCondition('${mode}','active_since', this.value)">
                                        ${daysOptions.replace(`value="${state.active_since||'-1'}"`, `value="${state.active_since||'-1'}" selected`)}
                                    </select></td>
                                </tr>
                                <tr>
                                    <td><label>Inactive since:</label></td>
                                    <td><select onchange="setFilterCondition('${mode}','inactive_since', this.value)">
                                        ${daysOptions.replace(`value="${state.inactive_since||'-1'}"`, `value="${state.inactive_since||'-1'}" selected`)}
                                    </select></td>
                                </tr>
                                <tr>
                                    <td><label>Joined since:</label></td>
                                    <td><select onchange="setFilterCondition('${mode}','joined_since', this.value)">
                                        ${daysOptions.replace(`value="${state.joined_since||'-1'}"`, `value="${state.joined_since||'-1'}" selected`)}
                                    </select></td>
                                </tr>
                                <tr>
                                    <td><label>Joined before:</label></td>
                                    <td><select onchange="setFilterCondition('${mode}','joined_before', this.value)">
                                        ${daysOptions.replace(`value="${state.joined_before||'-1'}"`, `value="${state.joined_before||'-1'}" selected`)}
                                    </select></td>
                                </tr>
                                <tr>
                                    <td><label>Min Points:</label></td>
                                    <td><input type="number" min="0" value="${state.points_min||''}" placeholder="0"
                                        onchange="setFilterCondition('${mode}','points_min', this.value || -1)"></td>
                                </tr>
                                <tr>
                                    <td><label>Max Points:</label></td>
                                    <td><input type="number" min="0" value="${state.points_max||''}" placeholder="∞"
                                        onchange="setFilterCondition('${mode}','points_max', this.value || -1)"></td>
                                </tr>
                            </table>
                            <br>
                            <button onclick="this.closest('dialog').close()">Close</button>
                        </dialog>
                    `;
                }
                else { console.error('Unknown filter dialog mode: ' + mode); return;}
                document.body.insertAdjacentHTML('beforeend', dialogHtml);
                setTimeout(() => {
                    const dialog = document.querySelector('dialog');
                    dialog.showModal();
                }, 100);
            }

            //
            //
            // region HTML
            //
            //

        </script>
    </head>
    <body>

        <header style="height: 30px">

            <select id="viewSelection" onchange="window.location.href=this.value">
                <option value="/members.html" selected> MEMBERS </option>
                <option value="/posts.html"> POSTS </option>
                <option value="/communities.html"> COMMUNITIES </option>
                <option value="/chats.html" > CHATS </option>
                <option value="/prompts.html"> PROMPTS </option>
                <option value="/data.html"> DATABASE </option>
            </select>
            |
            Total: <b id="memberAmount">---</b>
            |
            <button id="hide-show-filter" onclick="toggleFilterExpanded()"> </button>
            |
            <select id="membersViewSelection">
                <option value="list">LIST VIEW</option>
                <option value="card">CARD VIEW</option>
                <option value="graph">GRAPH VIEW</option>
            </select>
            |
            <!-- Secondary view are applied to the right, but only if the main view is
            list or card view -> since on graph view there is no space for that
            This is used to display all posts of the selected users or their communities etc.
             -->
            <span id="secondary-views">
                <small>Actions:</small>
                <button onclick="setCurrentSecondaryView('posts')">Posts</button>
                <button onclick="setCurrentSecondaryView('communities')">Communities</button>
                <button onclick="setCurrentSecondaryView('activity')">Activities</button>
                <button onclick="setCurrentSecondaryView('export')">Export</button>
            </span>
            <nav style="float: right">

                <select id="currentCommunitySelectorHeader" onchange="changeCurrentCommunity(this.value)"></select>

                <button onclick="window.location.href='/settings.html'"> Settings </button>
                <select id="themeSelection" onchange="lib.setTheme(this.value).then()">
                    <option value="blue"> Blue </option>
                    <option value="red"> Red </option>
                </select>
            </nav>

        </header>

        <article id="filter" style="display:none">
            <div style="margin-bottom: 5px">
                <input id="search-input" placeholder="Search for members..." onchange="filterState.searchTerm = this.value; loadMembers()">
                <select id="sort-select" onchange="setSort(this.value)">
                    <option value="name_asc">Name A-Z</option>
                    <option value="name_desc">Name Z-A</option>
                    <option value="points_desc">Points (high)</option>
                    <option value="points_asc">Points (low)</option>
                    <option value="last_active_desc">Last active (recent)</option>
                    <option value="last_active_asc">Last active (oldest)</option>
                    <option value="joined_desc">Joined (newest)</option>
                    <option value="joined_asc">Joined (oldest)</option>
                </select>
            </div>
            <div style="margin-bottom: 5px">
                Include: <button onclick="openFilterDialog('include')">+</button>
                <span id="filter-conditions-include"></span>
            </div>
            <div>
                Exclude: <button onclick="openFilterDialog('exclude')">+</button>
                <span id="filter-conditions-exclude"></span>
            </div>

        </article>

        <main style=" display: flex; flex-wrap: wrap; width: 100%;" id="members-view">
            <!-- MEMBERS VIEW RENDERED HERE -->
        </main>
    </body>
</html>